From 4cd70e4a0f9677490c2115f7fc0697e800857e66 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Sat, 22 Feb 2014 01:38:05 +1100
Subject: [PATCH] Wait a little bit when EOF is encountered and file is still
 open for writing

Reduce the amount of retries, slightly lower CPU usage
---
 mythtv/libs/libmythtv/ringbuffer.cpp | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/mythtv/libs/libmythtv/ringbuffer.cpp b/mythtv/libs/libmythtv/ringbuffer.cpp
index 880167369eb..bd20462cdc2 100644
--- a/mythtv/libs/libmythtv/ringbuffer.cpp
+++ b/mythtv/libs/libmythtv/ringbuffer.cpp
@@ -956,10 +956,15 @@ void RingBuffer::run(void)
             readsallowed = used >= fill_min || ateof ||
                 setswitchtonext || commserror;
 
-            if (0 == read_return && old_readpos == readpos &&
-                !IsRegisteredFileForWrite())
+            if (0 == read_return && old_readpos == readpos)
             {
-                if (livetvchain)
+                if (IsRegisteredFileForWrite())
+                {
+                    // We reached EOF, but file still open for writing
+                    // wait a little bit (60ms same wait as typical safe_read)
+                    generalWait.wait(&rwlock, 60);
+                }
+                else if (livetvchain)
                 {
                     if (!setswitchtonext && !ignoreliveeof &&
                         livetvchain->HasNext())
