From 9c48a57eedaaeb774783a2f745dfb04675d11061 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Fri, 6 Jan 2012 20:35:24 +0000
Subject: [PATCH] SQLite: (optimization) don't try to open journal file when
 reading on /vsicurl/

git-svn-id: https://svn.osgeo.org/gdal/trunk@23710 f0d54148-0727-0410-94bb-9a71ac55c965
---
 gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitevfs.cpp | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitevfs.cpp b/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitevfs.cpp
index 83f87183e6ec..a17bf0583ddf 100644
--- a/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitevfs.cpp
+++ b/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitevfs.cpp
@@ -252,7 +252,15 @@ static int OGRSQLiteVFSAccess (sqlite3_vfs* pVFS, const char *zName, int flags,
     VSIStatBufL sStatBufL;
     int nRet;
     if (flags == SQLITE_ACCESS_EXISTS)
-        nRet = VSIStatExL(zName, &sStatBufL, VSI_STAT_EXISTS_FLAG);
+    {
+        /* Do not try to check the presence of a journal on /vsicurl ! */
+        if ( strncmp(zName, "/vsicurl/", 9) == 0 &&
+             strlen(zName) > strlen("-journal") &&
+             strcmp(zName + strlen(zName) - strlen("-journal"), "-journal") == 0 )
+            nRet = -1;
+        else
+            nRet = VSIStatExL(zName, &sStatBufL, VSI_STAT_EXISTS_FLAG);
+    }
     else if (flags == SQLITE_ACCESS_READ)
     {
         VSILFILE* fp = VSIFOpenL(zName, "rb");
