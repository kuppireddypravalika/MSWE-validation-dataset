From 634fcae31cf94f8601803f8b36fa880bbd8d8e9d Mon Sep 17 00:00:00 2001
From: Dave Gamble <davegamble@gmail.com>
Date: Mon, 3 May 2021 23:44:02 +0100
Subject: [PATCH] danger! optimise the hell out of do loops. If a loop has no
 flow modification or cleverness, and is 16 ops or less, run the thing FAST.

---
 source/dsp56kEmu/dsp.cpp | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/source/dsp56kEmu/dsp.cpp b/source/dsp56kEmu/dsp.cpp
index 898d309a..07974972 100644
--- a/source/dsp56kEmu/dsp.cpp
+++ b/source/dsp56kEmu/dsp.cpp
@@ -430,6 +430,9 @@ namespace dsp56k
 		sr_set( SR_LF );
 
 		traceOp();
+		TWord looplen=_addr + 1  - getPC().var;
+		uint32_t simpleguess=getInstructionCounter() + looplen;
+		if (looplen>16) simpleguess=0;
 
 		// __________________
 		//
@@ -450,6 +453,21 @@ namespace dsp56k
 				break;
 			}
 
+			if (getInstructionCounter() == simpleguess)
+			{
+				const TWord startpc=hiword(reg.ss[ssIndex()]).var;
+				while (--reg.lc.var>0) {
+					setPC(startpc);
+					for (int i=0;i<looplen;i++)
+					{
+						pcCurrentInstruction = reg.pc.toWord();
+						execOp(fetchPC());
+					}
+				}
+				setPC(reg.la.var+1);
+				do_end();
+				return true;
+			}
 			--reg.lc.var;
 			setPC(hiword(reg.ss[ssIndex()]));
 		}
