From b9f601d29501b887b713c3e57c5d58a886e8195b Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Sun, 23 Sep 2012 18:06:49 +0000
Subject: [PATCH] ODBC: add optimized GetFeatureCount() implementation

git-svn-id: https://svn.osgeo.org/gdal/trunk@24961 f0d54148-0727-0410-94bb-9a71ac55c965
---
 .../ogrsf_frmts/odbc/ogrodbctablelayer.cpp    | 20 ++++++++++++++++++-
 1 file changed, 19 insertions(+), 1 deletion(-)

diff --git a/gdal/ogr/ogrsf_frmts/odbc/ogrodbctablelayer.cpp b/gdal/ogr/ogrsf_frmts/odbc/ogrodbctablelayer.cpp
index 7d986c752378..f32bbc2decdd 100644
--- a/gdal/ogr/ogrsf_frmts/odbc/ogrodbctablelayer.cpp
+++ b/gdal/ogr/ogrsf_frmts/odbc/ogrodbctablelayer.cpp
@@ -346,7 +346,25 @@ int OGRODBCTableLayer::TestCapability( const char * pszCap )
 int OGRODBCTableLayer::GetFeatureCount( int bForce )
 
 {
-    return OGRODBCLayer::GetFeatureCount( bForce );
+    if( m_poFilterGeom != NULL )
+        return OGRODBCLayer::GetFeatureCount( bForce );
+
+    CPLODBCStatement oStmt( poDS->GetSession() );
+    oStmt.Append( "SELECT COUNT(*) FROM " );
+    oStmt.Append( poFeatureDefn->GetName() );
+
+    if( pszQuery != NULL )
+        oStmt.Appendf( " WHERE %s", pszQuery );
+
+    if( !oStmt.ExecuteSQL() || !oStmt.Fetch() )
+    {
+        CPLError( CE_Failure, CPLE_AppDefined, 
+                  "GetFeatureCount() failed on query %s.\n%s",
+                  oStmt.GetCommand(), poDS->GetSession()->GetLastError() );
+        return OGRODBCLayer::GetFeatureCount(bForce);
+    }
+
+    return atoi(oStmt.GetColData(0));
 }
 
 /************************************************************************/
