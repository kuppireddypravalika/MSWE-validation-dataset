From c766af2263a4faa5a3f0732cab247475a1f07e8c Mon Sep 17 00:00:00 2001
From: Lukas Rusak <lorusak@gmail.com>
Date: Sat, 21 Jan 2023 14:51:15 -0800
Subject: [PATCH] CAESinkPipewire: move period calculation outside the loop

Signed-off-by: Lukas Rusak <lorusak@gmail.com>
---
 xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp b/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
index 98f593bd9fb35..093c96e67b771 100644
--- a/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
+++ b/xbmc/cores/AudioEngine/Sinks/pipewire/AESinkPipewire.cpp
@@ -507,6 +507,9 @@ unsigned int CAESinkPipewire::AddPackets(uint8_t** data, unsigned int frames, un
 
   m_stream->QueueBuffer(pwBuffer);
 
+  const auto period = std::chrono::duration<double, std::ratio<1>>(static_cast<double>(frames) /
+                                                                   m_format.m_sampleRate);
+
   do
   {
     pw_time time = m_stream->GetTime();
@@ -516,9 +519,6 @@ unsigned int CAESinkPipewire::AddPackets(uint8_t** data, unsigned int frames, un
 
     const auto now = std::chrono::steady_clock::now();
 
-    const auto period = std::chrono::duration<double, std::ratio<1>>(static_cast<double>(frames) /
-                                                                     m_format.m_sampleRate);
-
     if ((delay <= (m_latency - period)) || ((now - start) >= period))
       break;
 
