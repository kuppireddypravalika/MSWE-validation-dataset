From ee69a2a2e0b9cd0bba3d3e794b26f0aa9279c9e4 Mon Sep 17 00:00:00 2001
From: Yvonne Chen <yche@synopsys.com>
Date: Mon, 13 Jun 2022 06:37:19 +0200
Subject: [PATCH] allow for quite small scale (shift<-31) in conv, use 0 for
 shift/mul in this case

---
 src/caffe/util/math_functions.cpp | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/caffe/util/math_functions.cpp b/src/caffe/util/math_functions.cpp
index 130f1415..47ea5cea 100644
--- a/src/caffe/util/math_functions.cpp
+++ b/src/caffe/util/math_functions.cpp
@@ -600,7 +600,12 @@ int tfl_QuantizeMultiplier(double scale, int *shift) {
   double q_mul = std::frexp(scale, shift);
   long long quantized_multiplier = (long long) std::round(q_mul * (1ll<<31));
   CHECK_LT(quantized_multiplier, 1ll<<31);
-  CHECK_GE(*shift, -31);
+  //CHECK_GE(*shift, -31);
+  if(*shift< -31)
+  {
+    *shift = 0;
+    return int(0);
+  }
   return (int) quantized_multiplier;
 }
 int tfl_MultiplyByQuantizedMultiplier(int x, int q_mul, int shift) {
