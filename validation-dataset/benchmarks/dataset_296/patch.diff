From fd36e6e301fed174388ef67b996c34c9b16dba7e Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Mon, 16 Apr 2018 13:29:56 +0200
Subject: [PATCH] RAWDataset: don't allocate more than 500MB of work buffers.
 Fixes https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=7720. Credit to
 OSS Fuzz

---
 gdal/frmts/raw/rawdataset.cpp | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/gdal/frmts/raw/rawdataset.cpp b/gdal/frmts/raw/rawdataset.cpp
index 2fb8341649cb..1416adfa67cb 100644
--- a/gdal/frmts/raw/rawdataset.cpp
+++ b/gdal/frmts/raw/rawdataset.cpp
@@ -1260,7 +1260,8 @@ bool RAWDatasetCheckMemoryUsage(int nXSize, int nYSize, int nBands,
     // Currently each RawRasterBand need to allocate nLineSize
     GIntBig nLineSize =
         static_cast<GIntBig>(std::abs(nPixelOffset)) * (nXSize - 1) + nDTSize;
-    if( nBands > 0 && nLineSize > (INT_MAX / 2) / nBands )
+    constexpr int knMAX_BUFFER_MEM = INT_MAX / 4;
+    if( nBands > 0 && nLineSize > knMAX_BUFFER_MEM / nBands )
     {
         CPLError(CE_Failure, CPLE_OutOfMemory, "Too much memory needed");
         return false;
