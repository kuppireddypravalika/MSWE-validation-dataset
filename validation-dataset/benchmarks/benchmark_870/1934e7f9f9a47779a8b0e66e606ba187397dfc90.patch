From 1934e7f9f9a47779a8b0e66e606ba187397dfc90 Mon Sep 17 00:00:00 2001
From: Rafael Espindola <rafael.espindola@gmail.com>
Date: Wed, 6 Dec 2017 22:32:19 +0000
Subject: [PATCH] Add a call to std::vector::reserve.

This reduces total allocations when linking clang fsds from 263.21MB
to 174.62MB.

This also has some very nice speed improvements on some
benchmarks. Chromium and clang fsds link 6% faster.
---
 lld/ELF/Relocations.cpp | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/lld/ELF/Relocations.cpp b/lld/ELF/Relocations.cpp
index 69f5385e9f6f..13c3a4d55088 100644
--- a/lld/ELF/Relocations.cpp
+++ b/lld/ELF/Relocations.cpp
@@ -867,6 +867,9 @@ template <class ELFT, class RelTy>
 static void scanRelocs(InputSectionBase &Sec, ArrayRef<RelTy> Rels) {
   OffsetGetter GetOffset(Sec);
 
+  // Not all relocations end up in Sec.Relocations, but a lot do.
+  Sec.Relocations.reserve(Rels.size());
+
   for (auto I = Rels.begin(), End = Rels.end(); I != End; ++I) {
     const RelTy &Rel = *I;
     Symbol &Sym = Sec.getFile<ELFT>()->getRelocTargetSym(Rel);
