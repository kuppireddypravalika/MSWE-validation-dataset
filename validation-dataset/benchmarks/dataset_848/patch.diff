From fb0b00492182333eb34bdd9252f7f7d4c39ef307 Mon Sep 17 00:00:00 2001
From: David Korth <gerbilsoft@gerbilsoft.com>
Date: Mon, 15 May 2017 01:04:32 -0400
Subject: [PATCH] [win32] RP_ExtractIcon_Fallback: Improve environment string
 handling.

- Check the second ExpandEnvironmentStrings() return value.
- Use unique_ptr<wchar_t[]>.
- Use wstring::assign() instead of creating a temporary wstring.
---
 src/win32/RP_ExtractIcon_Fallback.cpp | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/src/win32/RP_ExtractIcon_Fallback.cpp b/src/win32/RP_ExtractIcon_Fallback.cpp
index a7f454bda9..2154627116 100644
--- a/src/win32/RP_ExtractIcon_Fallback.cpp
+++ b/src/win32/RP_ExtractIcon_Fallback.cpp
@@ -31,7 +31,9 @@ using namespace LibRomData;
 #include "RegKey.hpp"
 
 // C++ includes.
+#include <memory>
 #include <string>
+using std::unique_ptr;
 using std::wstring;
 
 // COM smart pointer typedefs.
@@ -292,10 +294,13 @@ LONG RP_ExtractIcon_Private::Fallback_int(RegKey &hkey_Assoc,
 			return GetLastError();
 		}
 
-		wchar_t *wbuf = static_cast<wchar_t*>(malloc(cchExpand*sizeof(wchar_t)));
-		cchExpand = ExpandEnvironmentStrings(defaultIcon.c_str(), wbuf, cchExpand);
-		defaultIcon = wstring(wbuf, cchExpand-1);
-		free(wbuf);
+		unique_ptr<wchar_t[]> wbuf(new wchar_t[cchExpand]);
+		cchExpand = ExpandEnvironmentStrings(defaultIcon.c_str(), wbuf.get(), cchExpand);
+		if (cchExpand == 0) {
+			// Error expanding the strings.
+			return GetLastError();
+		}
+		defaultIcon.assign(wbuf.get(), cchExpand-1);
 	}
 
 	// PrivateExtractIcons() is published as of Windows XP SP1,
