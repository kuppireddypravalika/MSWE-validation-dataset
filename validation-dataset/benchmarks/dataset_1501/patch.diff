From 497d2d57e731d81488e2c38b06d554ec5b605b94 Mon Sep 17 00:00:00 2001
From: "bernard.parisse" <bernard.parisse@23ce0884-8a58-47d3-bc5c-ddf1cd5b9f9e>
Date: Fri, 22 Oct 2021 17:42:22 +0000
Subject: [PATCH] [giac] attempt to improve round

git-svn-id: https://dev.geogebra.org/svn/trunk/geogebra/giac@69914 23ce0884-8a58-47d3-bc5c-ddf1cd5b9f9e
---
 src/giac/cpp/usual.cc | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/src/giac/cpp/usual.cc b/src/giac/cpp/usual.cc
index 7f034981..65ffebd2 100644
--- a/src/giac/cpp/usual.cc
+++ b/src/giac/cpp/usual.cc
@@ -6824,20 +6824,27 @@ namespace giac {
 	double d=std::pow(10.0,double(b.val));
 #endif
 	*/
-	gen d=10.0;
+	gen d=10.0,a=args._VECTptr->front();
 	if (b.val<0){
-	  gen gf=_floor(log10(abs(args._VECTptr->front(),contextptr),contextptr),contextptr); 
+	  gen gf=_floor(log10(abs(a,contextptr),contextptr),contextptr); 
 	  if (gf.type!=_INT_ && gf.type!=_FLOAT_)
 	    return gensizeerr(contextptr);
 	  b=-1-b-gf;
 	}
 	if (b.val>14)
 	  d=accurate_evalf(gen(10),int(b.val*3.32192809489+.5));
+	else
+	  d=accurate_evalf(gen(10),60);
 	d=pow(d,b.val,contextptr);
-	gen e=_round(d*args._VECTptr->front(),contextptr);
+	gen e=_round(d*a,contextptr);
 	if (b.val>14)
 	  e=accurate_evalf(e,int(b.val*3.32192809489+.5));
 	e=rdiv(e,d,contextptr);
+	if (b.val<=14){
+	  gen f=evalf_double(e,1,contextptr);
+	  if (!is_undef(f))
+	    return f;
+	}
 	return e;
       }
     }
