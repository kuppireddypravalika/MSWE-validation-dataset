From efabbaaf1220499976ddf5ad17dde628b877cdb5 Mon Sep 17 00:00:00 2001
From: Silvio Heinrich <plassy@web.de>
Date: Sun, 5 Jun 2011 08:49:34 +0200
Subject: [PATCH] When creating mipmaps for loaded brushes make sure to don't
 scale up hi-res brushes.

---
 krita/plugins/paintops/libbrush/kis_brush.cpp | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/krita/plugins/paintops/libbrush/kis_brush.cpp b/krita/plugins/paintops/libbrush/kis_brush.cpp
index 1660da0f553..06efc6b6e51 100644
--- a/krita/plugins/paintops/libbrush/kis_brush.cpp
+++ b/krita/plugins/paintops/libbrush/kis_brush.cpp
@@ -44,7 +44,8 @@
 
 #include "kis_brush_registry.h"
 
-#define MAXIMUM_SCALE 20
+const static int MAXIMUM_MIPMAP_SCALE = 10;
+const static int MAXIMUM_MIPMAP_SIZE  = 400;
 
 KisBrush::ColoringInformation::~ColoringInformation()
 {
@@ -569,10 +570,15 @@ void KisBrush::createScaledBrushes() const
     if (image().isNull()) {
         return;
     }
+    
     // Construct a series of brushes where each one's dimensions are
     // half the size of the previous one.
-    int width = image().width() * MAXIMUM_SCALE;
-    int height = image().height() * MAXIMUM_SCALE;
+    // IMORTANT: and make sure that a brush with a size > MAXIMUM_MIPMAP_SIZE
+    // will not get scaled up anymore or the memory consumption gets to height
+    // also don't scale the brush up more then MAXIMUM_MIPMAP_SCALE times
+    int scale  = qBound(1, MAXIMUM_MIPMAP_SIZE*2 / qMax(image().width(),image().height()), MAXIMUM_MIPMAP_SCALE);
+    int width  = image().width()  * scale;
+    int height = image().height() * scale;
 
     QImage scaledImage;
     while (true) {
