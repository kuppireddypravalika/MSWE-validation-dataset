From 17f775b2832563e6341488c745b86858e239847a Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Mon, 12 Mar 2018 12:37:38 +0000
Subject: [PATCH] GenBin: avoid excessive memory allocation attempt. Fixes
 https://oss-fuzz.com/v2/testcase-detail/5737765514772480. Credit to OSS Fuzz

git-svn-id: https://svn.osgeo.org/gdal/trunk@41745 f0d54148-0727-0410-94bb-9a71ac55c965
---
 gdal/frmts/raw/genbindataset.cpp | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/gdal/frmts/raw/genbindataset.cpp b/gdal/frmts/raw/genbindataset.cpp
index 26dc0613fb62..90c0790329f6 100644
--- a/gdal/frmts/raw/genbindataset.cpp
+++ b/gdal/frmts/raw/genbindataset.cpp
@@ -806,6 +806,16 @@ GDALDataset *GenBinDataset::Open( GDALOpenInfo * poOpenInfo )
         return nullptr;
     }
 
+    if( nBits < 0 &&
+        !RAWDatasetCheckMemoryUsage(
+                        poDS->nRasterXSize, poDS->nRasterYSize, nBands,
+                        nPixelOffset, nLineOffset, 0, nBandOffset,
+                        poDS->fpImage) )
+    {
+        delete poDS;
+        return nullptr;
+    }
+
     poDS->SetDescription( poOpenInfo->pszFilename );
     poDS->PamInitialize();
 
