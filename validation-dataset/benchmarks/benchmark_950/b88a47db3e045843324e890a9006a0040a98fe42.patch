From b88a47db3e045843324e890a9006a0040a98fe42 Mon Sep 17 00:00:00 2001
From: "ingo@mysql.com" <>
Date: Mon, 9 Aug 2004 11:39:26 +0200
Subject: [PATCH] bug#4497 - Serious regression if disk based TMP table is
 used. Solved performance problems by enabling write buffer.

---
 sql/sql_select.cc | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/sql/sql_select.cc b/sql/sql_select.cc
index 096b73c482f..7b688041acc 100644
--- a/sql/sql_select.cc
+++ b/sql/sql_select.cc
@@ -4533,6 +4533,20 @@ bool create_myisam_from_heap(THD *thd, TABLE *table, TMP_TABLE_PARAM *param,
     new_table.no_rows=1;
   }
 
+#ifdef TO_BE_DONE_LATER_IN_4_1
+  /*
+    To use start_bulk_insert() (which is new in 4.1) we need to find
+    all places where a corresponding end_bulk_insert() should be put.
+  */
+  table->file->info(HA_STATUS_VARIABLE); /* update table->file->records */
+  new_table.file->start_bulk_insert(table->file->records);
+#else
+  /*
+    HA_EXTRA_WRITE_CACHE can stay until close, no need to disable it explicitly.
+  */
+  new_table.file->extra(HA_EXTRA_WRITE_CACHE);
+#endif
+
   /* copy all old rows */
   while (!table->file->rnd_next(new_table.record[1]))
   {
