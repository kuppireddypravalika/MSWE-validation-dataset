From f5ff9957e5c32a91d2c21e6fec89abc0d5fcaea3 Mon Sep 17 00:00:00 2001
From: Hendrik Leppkes <h.leppkes@gmail.com>
Date: Thu, 8 Dec 2016 11:30:05 +0100
Subject: [PATCH] Set the guessed number of H264 out-of-order frames to at
 least 2

This avoids dropping frames in the most common broadcast streams while
still keeping decode latency low.

Fixes GitHub issue #113
---
 decoder/LAVVideo/decoders/avcodec.cpp | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/decoder/LAVVideo/decoders/avcodec.cpp b/decoder/LAVVideo/decoders/avcodec.cpp
index 84c4769c6..4fcf3696f 100644
--- a/decoder/LAVVideo/decoders/avcodec.cpp
+++ b/decoder/LAVVideo/decoders/avcodec.cpp
@@ -522,6 +522,10 @@ STDMETHODIMP CDecAvcodec::InitDecoder(AVCodecID codec, const CMediaType *pmt)
     if (lavPinInfo.has_b_frames >= 0) {
       DbgLog((LOG_TRACE, 10, L"-> Setting has_b_frames to %d", lavPinInfo.has_b_frames));
       m_pAVCtx->has_b_frames = lavPinInfo.has_b_frames;
+
+      // Set H264 to at least 2 B-Frames, which is the most common for broadcasts
+      if (codec == AV_CODEC_ID_H264 && m_pAVCtx->has_b_frames == 1)
+        m_pAVCtx->has_b_frames = 2;
     }
   }
 
