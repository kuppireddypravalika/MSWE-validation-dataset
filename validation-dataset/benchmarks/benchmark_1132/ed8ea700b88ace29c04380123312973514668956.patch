From ed8ea700b88ace29c04380123312973514668956 Mon Sep 17 00:00:00 2001
From: "Dirk O. Kaar" <dok@dok-net.net>
Date: Sat, 29 Feb 2020 16:19:33 +0100
Subject: [PATCH] With GCC on x86_64 Linux, use inline assembly instead of
 alloca() to set stack pointer to CoopTask stack on heap.

---
 src/CoopTaskBase.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/CoopTaskBase.cpp b/src/CoopTaskBase.cpp
index 71455d0..287db61 100644
--- a/src/CoopTaskBase.cpp
+++ b/src/CoopTaskBase.cpp
@@ -659,8 +659,14 @@ int32_t CoopTaskBase::initialize()
     {
         reinterpret_cast<unsigned*>(taskStackTop)[pos] = STACKCOOKIE;
     }
-#if defined(ARDUINO) || defined(__GNUC__)
-    char* bp = static_cast<char*>(alloca(reinterpret_cast<char*>(&bp) - (taskStackTop + taskStackSize + sizeof(STACKCOOKIE))));
+#if defined(__GNUC__) && (defined(__amd64__) || defined(__amd64) || defined(__x86_64__) || defined(__x86_64))
+    asm volatile (
+        "movq %0, %%rsp"
+        :
+        : "r" ((((long unsigned)taskStackTop + taskStackSize + (FULLFEATURES ? sizeof(STACKCOOKIE) : 0)) >> 4 ) << 4)
+    );
+#elif defined(ARDUINO) || defined(__GNUC__)
+    char* bp = static_cast<char*>(alloca(reinterpret_cast<char*>(&bp) - (taskStackTop + taskStackSize + (FULLFEATURES ? sizeof(STACKCOOKIE) : 0))));
 #else
 #error Setting stack pointer is not implemented on this target
 #endif
