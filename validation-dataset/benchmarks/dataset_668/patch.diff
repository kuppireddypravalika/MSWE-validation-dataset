From 14cac53635ff27025899215facc825ec071eef5b Mon Sep 17 00:00:00 2001
From: Tobias Junghans <tobydox@veyon.io>
Date: Mon, 25 Oct 2021 09:30:43 +0200
Subject: [PATCH] VeyonMaster: iterate over related features only in
 subFeatures()

---
 master/src/VeyonMaster.cpp | 28 +++++++++++++++-------------
 1 file changed, 15 insertions(+), 13 deletions(-)

diff --git a/master/src/VeyonMaster.cpp b/master/src/VeyonMaster.cpp
index edc0634d0..8428d250d 100644
--- a/master/src/VeyonMaster.cpp
+++ b/master/src/VeyonMaster.cpp
@@ -99,26 +99,28 @@ VeyonMaster::~VeyonMaster()
 
 FeatureList VeyonMaster::subFeatures( Feature::Uid parentFeatureUid ) const
 {
-	FeatureList features;
-
 	const auto disabledFeatures = VeyonCore::config().disabledFeatures();
-	const auto pluginUids = VeyonCore::pluginManager().pluginUids();
+	if( disabledFeatures.contains( parentFeatureUid.toString() ) )
+	{
+		return {};
+	}
 
-	for( const auto& pluginUid : pluginUids )
+	const auto& relatedFeatures = m_featureManager->relatedFeatures( parentFeatureUid );
+
+	FeatureList subFeatures;
+	subFeatures.reserve( relatedFeatures.size() );
+
+	for( const auto& relatedFeature : relatedFeatures )
 	{
-		for( const auto& feature : m_featureManager->features( pluginUid ) )
+		if( relatedFeature.testFlag( Feature::Flag::Master ) &&
+			relatedFeature.parentUid() == parentFeatureUid &&
+			disabledFeatures.contains( relatedFeature.uid().toString() ) == false )
 		{
-			if( feature.testFlag( Feature::Flag::Master ) &&
-				feature.parentUid() == parentFeatureUid &&
-				disabledFeatures.contains( parentFeatureUid.toString() ) == false &&
-				disabledFeatures.contains( feature.uid().toString() ) == false )
-			{
-				features += feature;
-			}
+			subFeatures += relatedFeature;
 		}
 	}
 
-	return features;
+	return subFeatures;
 }
 
 
