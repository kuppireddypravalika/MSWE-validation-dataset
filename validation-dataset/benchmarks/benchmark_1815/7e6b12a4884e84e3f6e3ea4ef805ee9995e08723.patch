From 7e6b12a4884e84e3f6e3ea4ef805ee9995e08723 Mon Sep 17 00:00:00 2001
From: Menci <huanghaorui301@gmail.com>
Date: Sun, 9 Feb 2020 06:12:06 +0000
Subject: [PATCH] Replace delete and fclose with RAII

---
 native/cgroup.cc | 12 ++++--------
 1 file changed, 4 insertions(+), 8 deletions(-)

diff --git a/native/cgroup.cc b/native/cgroup.cc
index 49979a8..6195b8b 100644
--- a/native/cgroup.cc
+++ b/native/cgroup.cc
@@ -68,9 +68,10 @@ bool InitializeCgroup()
         controllers.push_back(string(subsys_name));
     }
 
-    FILE *proc_mount = CHECKNULL(fopen("/proc/mounts", "re"));
-    mntent *temp_ent = new mntent, *ent;
-    while ((ent = getmntent_r(proc_mount, temp_ent,
+    std::unique_ptr<FILE, decltype(fclose) *> proc_mount(CHECKNULL(fopen("/proc/mounts", "re")), fclose);
+    std::unique_ptr<mntent> temp_ent = std::make_unique<mntent>();
+    mntent *ent;
+    while ((ent = getmntent_r(proc_mount.get(), temp_ent.get(),
                               buf,
                               sizeof(buf))) != NULL)
     {
@@ -86,11 +87,6 @@ bool InitializeCgroup()
             cgroup_mnt[*iter].push_back(fs::path(string(ent->mnt_dir)));
         }
     }
-    delete temp_ent;
-
-    // TODO: implement RAII here. `throw` will cause file descriptor leak for now.
-    if (proc_mount)
-        fclose(proc_mount);
 
     return cgroup_mnt.size() != 0;
 }
