From 23d952d666fdf5eab02edcb3ce5792d8ec505a75 Mon Sep 17 00:00:00 2001
From: Rohan Sawhney <sawhney_rohan@yahoo.co.in>
Date: Thu, 11 May 2023 16:55:02 -0700
Subject: [PATCH] much faster loading of models with many components

---
 apps/viewer/src/Viewer.cpp | 19 +++++++++++++++++--
 1 file changed, 17 insertions(+), 2 deletions(-)

diff --git a/apps/viewer/src/Viewer.cpp b/apps/viewer/src/Viewer.cpp
index 44046a7..d879dde 100644
--- a/apps/viewer/src/Viewer.cpp
+++ b/apps/viewer/src/Viewer.cpp
@@ -730,18 +730,33 @@ void Viewer::initBFF()
 			initSpline();
 			if (!state->surfaceIsClosed) {
 				// parameterize automatically for surfaces that are not closed
-				flattenWithTargetBoundary(BoundaryType::automatic);
+				removeVertexHandles();
+				DenseMatrix u(state->bff->data->bN);
+				state->bff->flatten(u, true);
+				mesh->projectUvsToPcaAxis();
 
 			} else {
 				// parameterize with cones for closed surfaces
 				int S = std::min(8, (int)mesh->vertices.size() - state->bff->data->bN);
 				if (S > 0) {
 					placeCones(S);
-					flattenWithCones();
+					if (state->handles.size() > 0) {
+						if (state->surfaceIsClosed) normalizeConeAngles();
+						if (cutSurface) updateCut();
+						state->bff->flattenWithCones(state->coneAngles, cutSurface);
+
+						// update
+						cutSurface = false;
+						mapIsDirty = false;
+						state->editBoundary = false;
+						if (state->mappedToSphere) cameras[1]->reset();
+						state->mappedToSphere = false;
+					}
 				}
 			}
 		}
 
+		update();
 		updateInstructionText();
 		updatePlotLabel();
 	}
