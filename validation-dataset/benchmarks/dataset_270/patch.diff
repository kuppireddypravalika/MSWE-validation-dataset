From 5532b6a13945f8f5c08fa8466b2d0e133bfbd301 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Sat, 4 Nov 2017 14:51:56 +0000
Subject: [PATCH] INGR: avoid excessive memory allocation attempt. Fixes
 https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=3912. Credit to OSS
 Fuzz

git-svn-id: https://svn.osgeo.org/gdal/trunk@40639 f0d54148-0727-0410-94bb-9a71ac55c965
---
 gdal/frmts/ingr/IntergraphBand.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/gdal/frmts/ingr/IntergraphBand.cpp b/gdal/frmts/ingr/IntergraphBand.cpp
index b00e123775af..7ad4265ec95e 100644
--- a/gdal/frmts/ingr/IntergraphBand.cpp
+++ b/gdal/frmts/ingr/IntergraphBand.cpp
@@ -639,7 +639,20 @@ IntergraphRLEBand::IntergraphRLEBand( IntergraphDataset *poDSIn,
     if( nRLESize == 0 )
         pabyRLEBlock = (GByte*) VSIMalloc( 1 );
     else if( nRLESize < INT_MAX )
+    {
+        if( nRLESize > 100 * 1024 * 1024 )
+        {
+            IntergraphDataset *poGDS = ( IntergraphDataset * ) poDS;
+            VSIFSeekL( poGDS->fp, 0, SEEK_END );
+            if( VSIFTellL( poGDS->fp ) < nRLESize )
+            {
+                CPLError(CE_Failure, CPLE_AppDefined, "File too short");
+                pabyRLEBlock = NULL;
+                return;
+            }
+        }
         pabyRLEBlock = (GByte*) VSIMalloc( nRLESize );
+    }
     if (pabyRLEBlock == NULL)
     {
         CPLError(CE_Failure, CPLE_AppDefined, "Cannot allocate %d bytes", nRLESize);
