From db2a27d897310d9f9d58ca2c7a72b033e712a865 Mon Sep 17 00:00:00 2001
From: Paul Harrison <mythtv@sky.com>
Date: Wed, 18 Nov 2015 16:24:15 +0000
Subject: [PATCH] AvFormatDecoder: ignore bad fps from H264Parser::frameRate()

It seems not all h264 files have vui_parameters which the parser relies on
to calculate the fps. Ignoring bad values from frameRate() causes us to fall
back to using the fps from ffmpeg which is usually accurate.
---
 mythtv/libs/libmythtv/avformatdecoder.cpp | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/mythtv/libs/libmythtv/avformatdecoder.cpp b/mythtv/libs/libmythtv/avformatdecoder.cpp
index c0bae28ba1c..c919d8ec2ca 100644
--- a/mythtv/libs/libmythtv/avformatdecoder.cpp
+++ b/mythtv/libs/libmythtv/avformatdecoder.cpp
@@ -3384,7 +3384,7 @@ int AvFormatDecoder::H264PreProcessPkt(AVStream *stream, AVPacket *pkt)
 
         bool res_changed = ((width  != (uint)current_width) ||
                             (height != (uint)current_height));
-        bool fps_changed = (seqFPS > fps+0.01f) || (seqFPS < fps-0.01f);
+        bool fps_changed = seqFPS > 0.0 && ((seqFPS > fps + 0.01f) || (seqFPS < fps - 0.01f));
 
         if (fps_changed || res_changed)
         {
@@ -3392,7 +3392,9 @@ int AvFormatDecoder::H264PreProcessPkt(AVStream *stream, AVPacket *pkt)
 
             current_width  = width;
             current_height = height;
-            fps            = seqFPS;
+
+            if (seqFPS > 0.0)
+                fps = seqFPS;
 
             gopset = false;
             prevgoppos = 0;
