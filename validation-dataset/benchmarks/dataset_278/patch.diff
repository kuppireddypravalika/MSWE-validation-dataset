From 233ae4a4b6f0e44636bdcb0ab377b865047fbbb8 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Sat, 13 Jan 2018 14:09:26 +0000
Subject: [PATCH] g2clib: avoid excessive memory allocation. Fixes
 https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=5285. Credit to OSS
 Fuzz

git-svn-id: https://svn.osgeo.org/gdal/trunk@41261 f0d54148-0727-0410-94bb-9a71ac55c965
---
 gdal/frmts/grib/degrib/g2clib/comunpack.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/gdal/frmts/grib/degrib/g2clib/comunpack.c b/gdal/frmts/grib/degrib/g2clib/comunpack.c
index 905e34fb8f36..0209bb293759 100644
--- a/gdal/frmts/grib/degrib/g2clib/comunpack.c
+++ b/gdal/frmts/grib/degrib/g2clib/comunpack.c
@@ -82,6 +82,14 @@ int comunpack(unsigned char *cpack,g2int cpack_length,g2int lensec,g2int idrsnum
          return(0);
       }
 
+      /* To avoid excessive memory allocations. Not completely sure */
+      /* if this test is appropriate (the 10 and 2 are arbitrary), */
+      /* but it doesn't seem to make sense to have ngroups much larger than */
+      /* ndpts */
+      if( ngroups < 0 || ngroups - 10 > ndpts / 2 ) {
+          return -1;
+      }
+
       /* Early test in particular case for more general test belows */
       /* "Test to see if the group widths and lengths are consistent with number of */
       /*  values, and length of section 7. */
