From e762a4ceef2d38e70cdff34a1dc05ee5f588db9d Mon Sep 17 00:00:00 2001
From: Eugene Paskevich <eugene@raptor.kiev.ua>
Date: Wed, 28 Oct 2015 18:50:13 +0200
Subject: [PATCH] Shorten up the transparency checking runtime.

Mostly by checking center and sub-center pixels.
And by fixing the breakage of the loop.
---
 sniproxy.cpp | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/sniproxy.cpp b/sniproxy.cpp
index 40e8bc7..ca2667f 100644
--- a/sniproxy.cpp
+++ b/sniproxy.cpp
@@ -192,11 +192,15 @@ void SNIProxy::update()
 {
     const QImage image = getImageNonComposite();
 
-    bool isTransparentImage = true;
     int w = image.width();
     int h = image.height();
 
-    for (int x = 0; x < w; ++x) {
+    // check for the center and sub-center pixels first and avoid full image scan
+    bool isTransparentImage = qAlpha(image.pixel(w >> 1, h >> 1)) + qAlpha(image.pixel(w >> 2, h >> 2)) == 0;
+
+    // skip scan altogether if sub-center pixel found to be opaque
+    // and break out from the outer loop too on full scan
+    for (int x = 0; x < w && isTransparentImage; ++x) {
 	for (int y = 0; y < h; ++y) {
 	    if (qAlpha(image.pixel(x, y))) {
 		// Found an opaque pixel.
