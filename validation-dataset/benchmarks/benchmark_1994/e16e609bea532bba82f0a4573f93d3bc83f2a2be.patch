From e16e609bea532bba82f0a4573f93d3bc83f2a2be Mon Sep 17 00:00:00 2001
From: Tobias Junghans <tobydox@veyon.io>
Date: Fri, 3 Aug 2018 13:11:53 +0200
Subject: [PATCH] Core: VncConnection: simplify message formatting

We can reduce memory allocations by using ANSI C vsnprintf() instead of
QString-based variants. Also fixes warnings issued by Valgrind.
---
 core/src/VncConnection.cpp | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/core/src/VncConnection.cpp b/core/src/VncConnection.cpp
index 7d01443bd..6d658848a 100644
--- a/core/src/VncConnection.cpp
+++ b/core/src/VncConnection.cpp
@@ -203,11 +203,15 @@ void VncConnection::hookOutputHandler( const char* format, ... )
 	va_list args;
 	va_start( args, format );
 
-	const auto message = QString::asprintf( format, args ); // Flawfinder: ignore
+	static const int MaxMessageLength = 256;
+	char message[MaxMessageLength];
+
+	vsnprintf( message, MaxMessageLength, format, args );
+	message[MaxMessageLength-1] = 0;
 
 	va_end(args);
 
-	qDebug() << "VncConnection: VNC message:" << message.trimmed();
+	qDebug( "VncConnection: VNC message: %s", message );
 }
 
 
