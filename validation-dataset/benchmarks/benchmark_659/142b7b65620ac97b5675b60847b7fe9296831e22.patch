From 142b7b65620ac97b5675b60847b7fe9296831e22 Mon Sep 17 00:00:00 2001
From: Sergio Martins <smartins@kde.org>
Date: Tue, 27 Dec 2016 16:50:59 +0000
Subject: [PATCH] Make incorrect-emit check 4x faster

Don't track signals and slots of non-qobjects, it's expensive.
---
 AccessSpecifierManager.cpp | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/AccessSpecifierManager.cpp b/AccessSpecifierManager.cpp
index ad915cfa..d775cbfc 100644
--- a/AccessSpecifierManager.cpp
+++ b/AccessSpecifierManager.cpp
@@ -26,6 +26,7 @@
 
 #include "StringUtils.h"
 #include "HierarchyUtils.h"
+#include "QtUtils.h"
 
 #include <clang/Basic/SourceManager.h>
 #include <clang/Parse/Parser.h>
@@ -152,8 +153,10 @@ void AccessSpecifierManager::VisitDeclaration(Decl *decl)
     const auto &sm = m_ci.getSourceManager();
 
     if (record) {
-        // We got a new record, lets fetch signals and slots that the pre-processor gathered
+        if (!QtUtils::isQObject(record))
+            return;
 
+        // We got a new record, lets fetch signals and slots that the pre-processor gathered
         ClazySpecifierList &specifiers = entryForClassDefinition(record);
 
         auto it = m_preprocessorCallbacks->m_qtAccessSpecifiers.begin();
@@ -166,11 +169,9 @@ void AccessSpecifierManager::VisitDeclaration(Decl *decl)
             }
         }
     } else if (accessSpec) {
-
         DeclContext *declContext = accessSpec->getDeclContext();
         auto record = dyn_cast<CXXRecordDecl>(declContext);
-        if (!record) {
-            llvm::errs() << "Received access specifier without class definition\n";
+        if (!record || !QtUtils::isQObject(record)) {
             return;
         }
 
