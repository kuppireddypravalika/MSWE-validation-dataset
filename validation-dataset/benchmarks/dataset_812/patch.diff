From 8c49481ec8d79390180c4df88fa9efd5f6f05615 Mon Sep 17 00:00:00 2001
From: kmurray <k.murray@utoronto.ca>
Date: Wed, 6 Sep 2017 12:35:29 -0400
Subject: [PATCH] vpr: Use number of pins per grid tile to initialize min W
 search

Previously we used the maximum number of pins per-block (not normalized
by block area). The result was that for large blocks with many pins the
initial channel width guess was unreasonable (i.e. > 1000) which
triggered the router to abort.

Normalizing by the block area fixes this issue.
---
 vpr/SRC/base/place_and_route.cpp | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/vpr/SRC/base/place_and_route.cpp b/vpr/SRC/base/place_and_route.cpp
index 3e5e79a947d..89ae69bbe67 100644
--- a/vpr/SRC/base/place_and_route.cpp
+++ b/vpr/SRC/base/place_and_route.cpp
@@ -289,7 +289,9 @@ static int binary_search_place_and_route(t_placer_opts placer_opts,
 
     max_pins_per_clb = 0;
     for (i = 0; i < device_ctx.num_block_types; i++) {
-        max_pins_per_clb = max(max_pins_per_clb, device_ctx.block_types[i].num_pins);
+        t_type_ptr type = &device_ctx.block_types[i];
+        //Use the maximum number of pins normalized by block area
+        max_pins_per_clb = max(max_pins_per_clb, type->num_pins) / (type->width * type->height);
     }
 
     clb_opins_used_locally = alloc_route_structs();
