From 2db5f479a2a54223ea27fb1a2765a6a3ee88377f Mon Sep 17 00:00:00 2001
From: Adam Novak <anovak@soe.ucsc.edu>
Date: Thu, 3 Jun 2021 16:25:29 -0700
Subject: [PATCH] Rewrite parallel snarl finding from a dynamic loop to
 explicit OMP tasks

---
 src/snarls.cpp | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/src/snarls.cpp b/src/snarls.cpp
index 55320cd0d3b..a4407bfa942 100644
--- a/src/snarls.cpp
+++ b/src/snarls.cpp
@@ -673,11 +673,21 @@ const vector<const Snarl*>& SnarlManager::top_level_snarls() const {
 }
     
 void SnarlManager::for_each_top_level_snarl_parallel(const function<void(const Snarl*)>& lambda) const {
-#pragma omp parallel for schedule(dynamic, 1)
-    for (int i = 0; i < roots.size(); i++) {
-        lambda(roots[i]);
+//#pragma omp parallel for schedule(dynamic, 1)
+    #pragma omp parallel
+    {
+        #pragma omp single
+        {
+            for (int i = 0; i < roots.size(); i++) {
+                #pragma omp task firstprivate(i)
+                {
+                    lambda(roots[i]);
+                }
+            }
+
+        }
+    }
     }
-}
     
 void SnarlManager::for_each_top_level_snarl(const function<void(const Snarl*)>& lambda) const {
     for (const Snarl* snarl : roots) {
