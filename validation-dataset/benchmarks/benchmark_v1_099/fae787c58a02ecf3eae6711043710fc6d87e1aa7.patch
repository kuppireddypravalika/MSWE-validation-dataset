From fae787c58a02ecf3eae6711043710fc6d87e1aa7 Mon Sep 17 00:00:00 2001
From: Jonathan Behrens <fintelia@gmail.com>
Date: Tue, 21 Jul 2020 08:53:00 -0400
Subject: [PATCH] Always set PTE A/D bits to avoid expensive microcode assists

---
 kernel/hwvm.cc | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/kernel/hwvm.cc b/kernel/hwvm.cc
index 9412ef5be..4c36163c8 100644
--- a/kernel/hwvm.cc
+++ b/kernel/hwvm.cc
@@ -780,6 +780,9 @@ page_map_cache::~page_map_cache()
 void
 page_map_cache::insert(uintptr_t va, pme_t pte)
 {
+  if (pte & PTE_P)
+    pte |= PTE_A | PTE_D;
+
   pml4s.user->find(va).create(PTE_U & pte, parent_, pml4s.user)->store(pte, memory_order_relaxed);
   if (va < KGLOBAL) {
     pml4s.kernel->find(va).create(PTE_U & pte, parent_, pml4s.user)->store(pte, memory_order_relaxed);
