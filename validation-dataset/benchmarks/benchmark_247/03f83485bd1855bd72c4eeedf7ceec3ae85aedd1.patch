From 03f83485bd1855bd72c4eeedf7ceec3ae85aedd1 Mon Sep 17 00:00:00 2001
From: Chris Lattner <sabre@nondot.org>
Date: Mon, 10 Jul 2006 06:16:26 +0000
Subject: [PATCH] Only do an expensive walk over the entire identifier table if
 the diagnostic that needs it is enabled.

llvm-svn: 38690
---
 clang/Lex/Preprocessor.cpp | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/clang/Lex/Preprocessor.cpp b/clang/Lex/Preprocessor.cpp
index c3fc8b94081..420a2b807bd 100644
--- a/clang/Lex/Preprocessor.cpp
+++ b/clang/Lex/Preprocessor.cpp
@@ -991,8 +991,11 @@ void Preprocessor::HandleEndOfFile(LexerToken &Result, bool isEndOfMacro) {
   delete CurLexer;
   CurLexer = 0;
 
-  // This is the end of the top-level file.
-  Identifiers.VisitIdentifiers(UnusedIdentifierReporter(*this));
+  // This is the end of the top-level file.  If the diag::pp_macro_not_used
+  // diagnostic is enabled, walk all of the identifiers, looking for macros that
+  // have not been used.
+  if (Diags.getDiagnosticLevel(diag::pp_macro_not_used) != Diagnostic::Ignored)
+    Identifiers.VisitIdentifiers(UnusedIdentifierReporter(*this));
 }
 
 /// HandleEndOfMacro - This callback is invoked when the lexer hits the end of
