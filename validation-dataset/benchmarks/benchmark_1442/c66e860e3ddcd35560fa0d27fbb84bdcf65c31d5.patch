From c66e860e3ddcd35560fa0d27fbb84bdcf65c31d5 Mon Sep 17 00:00:00 2001
From: Sainan <sainan@calamity.gg>
Date: Tue, 5 Dec 2023 21:01:27 +0100
Subject: [PATCH] Perform concat at compile-time for the trivial case of VKSTR
 .. TK_STRING

---
 src/lparser.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/src/lparser.cpp b/src/lparser.cpp
index e83ddaab1..7d56ec930 100644
--- a/src/lparser.cpp
+++ b/src/lparser.cpp
@@ -38,6 +38,7 @@
 #include "lsuggestions.hpp"
 #include "ltable.h"
 #include "lauxlib.h"
+#include "lvm.h"
 
 #include "lerrormessage.hpp"
 
@@ -3383,6 +3384,18 @@ static BinOpr subexpr (LexState *ls, expdesc *v, int limit, TypeHint *prop, int
       if (op == OPR_CONCAT) {
         if (prop)
           prop->emplaceTypeDesc(VT_STR);
+        if (v->k == VKSTR && ls->t.token == TK_STRING) {
+          setsvalue2s(ls->L, ls->L->top.p, v->u.strval);
+          ls->L->top.p++;
+          setsvalue2s(ls->L, ls->L->top.p, ls->t.seminfo.ts);
+          ls->L->top.p++;
+          luaV_concat(ls->L, 2);
+		  ls->L->top.p--;
+          v->u.strval = tsvalue(s2v(ls->L->top.p));
+          luaX_next(ls);
+		  op = getbinopr(ls->t.token);
+          continue;
+        }
       }
       else if (op == OPR_COAL) {
         if (luaK_isalwaysnil(ls, v)) {
