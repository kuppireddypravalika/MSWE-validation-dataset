From bfd7b9d7e12fec70ca4137ce56958cf442013ffb Mon Sep 17 00:00:00 2001
From: Evgeny Vrublevsky <me@veg.by>
Date: Sun, 5 Jun 2022 21:01:13 +0300
Subject: [PATCH] Brown noise: add leaky integrator to the SoX algorithm to
 reduce low frequencies.

---
 CKeepSession.cpp | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/CKeepSession.cpp b/CKeepSession.cpp
index 2319efd..52a366a 100644
--- a/CKeepSession.cpp
+++ b/CKeepSession.cpp
@@ -751,16 +751,17 @@ HRESULT CKeepSession::Render()
 				lcg_state = lcg_state * 6364136223846793005ULL + 1; // LCG Musl.
 				double white = (static_cast<double>((lcg_state >> 32) & 0x7FFFFFFF) / static_cast<double>(0x7FFFFFFFU)) * 2.0 - 1.0; // -1..1
 
-#if 0
+#if 1
 
-				// Algorithm from the SoX. Feels like there are too many low frequencies.
+				// Algorithm from the SoX + leaky integrator that reduces low frequencies.
 				m_curr_value += white * (1.0 / 16);
+				m_curr_value /= 1.02; // The leaky integrator.
 				m_curr_value = fmod(m_curr_value, 4);
 				double norm_value = m_curr_value;
 
 #else
 
-				// Algorithm from the noise.js. Sounds better.
+				// Algorithm from the noise.js.
 				m_curr_value += white * 0.02;
 				m_curr_value /= 1.02;
 				double norm_value = m_curr_value * 3.5; // -3.5 .. 3.5
