From af4ca216bd6d27af5c43b1bb4c896632c3068195 Mon Sep 17 00:00:00 2001
From: Marek Marecki <marekjm@ozro.pw>
Date: Wed, 24 Feb 2016 21:05:15 +0100
Subject: [PATCH] Use viua::operand::extractString() as it is future-proof

---
 src/thread/instr/tcmechanism.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/thread/instr/tcmechanism.cpp b/src/thread/instr/tcmechanism.cpp
index 469e782e4..82ba8c26b 100644
--- a/src/thread/instr/tcmechanism.cpp
+++ b/src/thread/instr/tcmechanism.cpp
@@ -56,7 +56,7 @@ byte* Thread::pull(byte* addr) {
 byte* Thread::vmenter(byte* addr) {
     /*  Run enter instruction.
      */
-    string block_name = string(addr);
+    string block_name = viua::operand::extractString(addr);
 
     bool block_found = (cpu->block_addresses.count(block_name) or cpu->linked_blocks.count(block_name));
     if (not block_found) {
@@ -72,7 +72,7 @@ byte* Thread::vmenter(byte* addr) {
         jump_base = cpu->linked_modules.at(cpu->linked_blocks.at(block_name).first).second;
     }
 
-    try_frame_new->return_address = (addr+block_name.size());
+    try_frame_new->return_address = addr; // address has already been adjusted by extractString()
     try_frame_new->associated_frame = frames.back();
     try_frame_new->block_name = block_name;
 
