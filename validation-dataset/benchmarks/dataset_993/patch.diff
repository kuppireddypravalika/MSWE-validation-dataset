From 38a8fdf173e7daf25984054f710d8d6af9f880a3 Mon Sep 17 00:00:00 2001
From: Matthew Fioravante <fmatthew5876@gmail.com>
Date: Sun, 24 Nov 2019 19:13:43 -0500
Subject: [PATCH] WaveEffect: Start phase offset from top of screen if clipped

Emulates RPG_RT rendering of wave pictures, including
bugs that make moving pictures look faster or slower than
they should be.
---
 src/bitmap.cpp | 15 ++++++++-------
 1 file changed, 8 insertions(+), 7 deletions(-)

diff --git a/src/bitmap.cpp b/src/bitmap.cpp
index cee19f9f18..3bb27f0003 100644
--- a/src/bitmap.cpp
+++ b/src/bitmap.cpp
@@ -734,14 +734,15 @@ void Bitmap::WaverBlit(int x, int y, double zoom_x, double zoom_y, Bitmap const&
 
 	int height = static_cast<int>(std::floor(src_rect.height * zoom_y));
 	int width  = static_cast<int>(std::floor(src_rect.width * zoom_x));
-	for (int i = 0; i < height; i++) {
+	const auto yclip = y < 0 ? -y : 0;
+	const auto yend = std::min(height, this->height() - y);
+	for (int i = yclip; i < yend; i++) {
 		int dy = y + i;
-		if (dy < 0)
-			continue;
-		if (dy >= this->height())
-			break;
-		double sy = i * 360.0 / (32.0 * zoom_y);
-		int offset = 2 * zoom_x * depth * std::sin((phase + sy) * M_PI / 180);
+		// RPG_RT starts the effect from the top of the screen even if the image is clipped. The result
+		// is that moving images which cross the top of the screen can appear to go too fast or too slow
+		// in RPT_RT. The (i - yclip) is RPG_RT compatible behavior. Just (i) would be more correct.
+		const double sy = (i - yclip) * (2 * M_PI) / (32.0 * zoom_y);
+		const int offset = 2 * zoom_x * depth * std::sin(phase + sy);
 
 		pixman_image_composite32(src.GetOperator(mask),
 								 src.bitmap, mask, bitmap,
