From 705d2411ba23cff2ab8f89013cd0a8fff365562e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lasse=20=C3=96=C3=B6rni?= <loorni@gmail.com>
Date: Wed, 12 Feb 2014 15:05:26 +0200
Subject: [PATCH] Acquire event data for work item completion only when
 necessary. These are pooled by the Context so it shouldn't hurt performance.

---
 Source/Engine/Core/WorkQueue.cpp | 7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

diff --git a/Source/Engine/Core/WorkQueue.cpp b/Source/Engine/Core/WorkQueue.cpp
index 7f29603191..5248e24dd5 100644
--- a/Source/Engine/Core/WorkQueue.cpp
+++ b/Source/Engine/Core/WorkQueue.cpp
@@ -273,10 +273,6 @@ void WorkQueue::ProcessItems(unsigned threadIndex)
 
 void WorkQueue::PurgeCompleted()
 {
-    using namespace WorkItemCompleted;
-    
-    VariantMap& eventData = GetEventDataMap();
-    
     // Purge completed work items and send completion events.
     for (List<SharedPtr<WorkItem> >::Iterator i = workItems_.Begin(); i != workItems_.End();)
     {
@@ -284,6 +280,9 @@ void WorkQueue::PurgeCompleted()
         {
             if ((*i)->sendEvent_)
             {
+                using namespace WorkItemCompleted;
+                
+                VariantMap& eventData = GetEventDataMap();
                 eventData[P_ITEM] = static_cast<void*>(i->Get());
                 SendEvent(E_WORKITEMCOMPLETED, eventData);
             }
