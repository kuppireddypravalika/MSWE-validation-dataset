From 4e617f170f534bc22e088a05dbccc5819dbe2701 Mon Sep 17 00:00:00 2001
From: Hendrik Leppkes <h.leppkes@gmail.com>
Date: Tue, 20 Dec 2011 13:57:56 +0100
Subject: [PATCH] Only initialize ffmpeg once.

---
 demuxer/Demuxers/LAVFDemuxer.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/demuxer/Demuxers/LAVFDemuxer.cpp b/demuxer/Demuxers/LAVFDemuxer.cpp
index de803afcd..d4e99510c 100644
--- a/demuxer/Demuxers/LAVFDemuxer.cpp
+++ b/demuxer/Demuxers/LAVFDemuxer.cpp
@@ -39,6 +39,8 @@ extern "C" {
 extern void lavf_get_iformat_infos(AVInputFormat *pFormat, const char **pszName, const char **pszDescription);
 extern AVInputFormat lav_mkv_demuxer;
 
+static volatile int ffmpeg_initialized = 0;
+
 static const AVRational AV_RATIONAL_TIMEBASE = {1, AV_TIME_BASE};
 
 void CLAVFDemuxer::ffmpeg_init()
@@ -48,8 +50,12 @@ void CLAVFDemuxer::ffmpeg_init()
   av_log_set_callback(lavf_log_callback);
 #endif
 
-  av_register_all();
-  av_register_input_format(&lav_mkv_demuxer);
+  if (!ffmpeg_initialized) {
+    ffmpeg_initialized = 1;
+
+    av_register_all();
+    av_register_input_format(&lav_mkv_demuxer);
+  }
 }
 
 std::set<FormatInfo> CLAVFDemuxer::GetFormatList()
