From 4ec98b014cae9680aca3f04d534c00599734ab80 Mon Sep 17 00:00:00 2001
From: Christophe Grosjean <pykoder@gmail.com>
Date: Fri, 12 Aug 2011 02:18:01 +0200
Subject: [PATCH] Inlining mcs_send (stage 3)

---
 front/server_sec.hpp | 17 +++++++----------
 1 file changed, 7 insertions(+), 10 deletions(-)

diff --git a/front/server_sec.hpp b/front/server_sec.hpp
index 4f2c7e2443..e86bee8905 100644
--- a/front/server_sec.hpp
+++ b/front/server_sec.hpp
@@ -395,21 +395,18 @@ struct server_sec {
 // -------------------------
 //        McsOut pdu(stream);
         X224Out tpdu(X224Packet::DT_TPDU, stream);
-        stream.mcs_hdr = stream.p;
-        stream.p += 8;
-//-------------------------
 
-        stream.out_copy_bytes((char*)lic3, sizeof(lic3));
-
-// -------------------------
-//        pdu.end()
-//        pdu.send(this->trans);
-        stream.mark_end();
-        this->mcs_layer.mcs_send(stream, MCS_GLOBAL_CHANNEL);
+        stream.out_uint8(MCS_SDIN << 2);
+        stream.out_uint16_be(this->mcs_layer.userid);
+        stream.out_uint16_be(MCS_GLOBAL_CHANNEL);
+        stream.out_uint8(0x70);
+        stream.out_uint16_be((8+20)|0x8000);
+        stream.out_copy_bytes((char*)lic3, 20);
 
         tpdu.end();
         tpdu.send(this->trans);
 // ----------------------------
+
     }
 
     void server_sec_rsa_op()
