From 3a5fd62aa080e3e57939b9062fd859a2b95a5917 Mon Sep 17 00:00:00 2001
From: Benjamin Berkels <torr.samaho@quantentunnel.de>
Date: Sun, 22 Jun 2014 10:45:00 +0200
Subject: [PATCH] DATABASE_SaveIncrementEntryInt now uses a single SQL query to
 increment the value.

---
 src/za_database.cpp | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/src/za_database.cpp b/src/za_database.cpp
index d0fe03d88..6eaa0ad74 100644
--- a/src/za_database.cpp
+++ b/src/za_database.cpp
@@ -434,11 +434,12 @@ void DATABASE_SaveIncrementEntryInt ( const char *Namespace, const char *EntryNa
 	FString newVal;
 	if ( DATABASE_EntryExists ( Namespace, EntryName ) )
 	{
-		// [BB] Try to make the get/set pair atomic.
-		database_ExecuteCommand ( "BEGIN EXCLUSIVE TRANSACTION" );
-		newVal.AppendFormat ( "%d", DATABASE_GetEntry ( Namespace, EntryName ).ToLong() + Increment );
-		DATABASE_SetEntry ( Namespace, EntryName, newVal.GetChars() );
-		database_ExecuteCommand ( "COMMIT TRANSACTION" );
+		// [BB] Get the old value and set the incremented value in a single query.
+		DataBaseCommand cmd ( "UPDATE "TABLENAME" SET Value=(SELECT CAST(Value AS INTEGER) FROM "TABLENAME" WHERE Namespace=?1 AND KeyName=?2)+?3,Timestamp=("TIMEQUERY") WHERE Namespace=?1 AND KeyName=?2" );
+		cmd.bindString ( 1, Namespace );
+		cmd.bindString ( 2, EntryName );
+		cmd.bindInt ( 3, Increment );
+		cmd.exec ( );
 	}
 	else
 	{
