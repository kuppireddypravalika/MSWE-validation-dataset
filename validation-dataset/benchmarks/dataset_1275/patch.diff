From 039fada23731a9b03b69b22094da0ff7822850db Mon Sep 17 00:00:00 2001
From: Max Kellermann <max@duempel.org>
Date: Thu, 18 Dec 2008 13:07:39 +0100
Subject: [PATCH] mbid: don't read the UFID frame if it is too short

Don't bother to waste any resources on the read() when we already know
that the frame is too small, and we can't use it anyway.
---
 mbid.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/mbid.c b/mbid.c
index ee88ef4..a0a4e7c 100644
--- a/mbid.c
+++ b/mbid.c
@@ -373,11 +373,11 @@ getMP3_MBID(const char *path, char mbid[MBID_BUFFER_SIZE])
             fseek(fp,2,SEEK_CUR);
             debug("Reading %d bytes from frame %s\n",frame_size,frame);
 
-            if (memcmp(frame,"UFID",4) == 0) {
+            if (frame_size >= 59 && memcmp(frame, "UFID", 4) == 0) {
                 char frame_data[frame_size + 1];
                 ret = mfile(frame_size, frame_data, fp);
-                if (ret && frame_size >= 59 &&
-                    strncmp(frame_data, "http://musicbrainz.org", 22) == 0) {
+                if (ret &&
+                    memcmp(frame_data, "http://musicbrainz.org", 22) == 0) {
                     char *tmbid = frame_data;
                     tmbid = frame_data + 23;
                     frame_data[frame_size] = 0;
