From fcb1f26c9f6c411e4374662a186d77aee7267003 Mon Sep 17 00:00:00 2001
From: senquack <dansilsby@gmail.com>
Date: Tue, 15 Nov 2016 02:54:49 -0500
Subject: [PATCH] mipsrec: Use direct addressing to invalidate code in
 StoreToAddr()

Now that we have ADR_HI()/ADR_LO() GAS %hi/%lo equivalents, we can
optimize load/store addressing.

This eliminates load dependency on psxRegs.reserved
---
 src/recompiler/mips/rec_lsu.cpp.h | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/recompiler/mips/rec_lsu.cpp.h b/src/recompiler/mips/rec_lsu.cpp.h
index 2b1f1eea..edc5b063 100644
--- a/src/recompiler/mips/rec_lsu.cpp.h
+++ b/src/recompiler/mips/rec_lsu.cpp.h
@@ -354,7 +354,7 @@ static void StoreToAddr(int count)
 
 	icount = count;
 	u32 *backpatch_label_exit_1 = 0;
-	LW(TEMP_3, PERM_REG_1, off(reserved));
+	LUI(TEMP_3, ADR_HI(recRAM)); // temp_3 = upper code block ptr array addr
 	do {
 		u32 opcode = *(u32 *)((char *)PSXM(PC));
 		s32 imm = _fImm_(opcode);
@@ -381,7 +381,7 @@ static void StoreToAddr(int count)
 			// NOTE: Branch delay slot will contain the instruction below
 		}
 		// Important: this should be the last opcode in the loop (see note above)
-		SW(0, TEMP_1, 0);
+		SW(0, TEMP_1, ADR_LO(recRAM));  // set code block ptr to NULL
 
 		PC += 4;
 
