From 537c5775edf940b1bd37fcb0c173d7cc7607cd58 Mon Sep 17 00:00:00 2001
From: Tom Schuster <evilpies@gmail.com>
Date: Wed, 6 Oct 2010 12:04:31 -0700
Subject: [PATCH] Bug 601689 - Optimize GetArrayElement for arguments objects
 (r=lw)

--HG--
extra : rebase_source : 6360a47b95660da477a1f312ab8654a23e4019c1
---
 js/src/jsarray.cpp | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/js/src/jsarray.cpp b/js/src/jsarray.cpp
index 4542b07de97..e1f8c992767 100644
--- a/js/src/jsarray.cpp
+++ b/js/src/jsarray.cpp
@@ -103,8 +103,9 @@
 #include "jsvector.h"
 
 #include "jsatominlines.h"
-#include "jsobjinlines.h"
 #include "jscntxtinlines.h"
+#include "jsinterpinlines.h"
+#include "jsobjinlines.h"
 
 using namespace js;
 using namespace js::gc;
@@ -456,6 +457,17 @@ GetArrayElement(JSContext *cx, JSObject *obj, jsdouble index, JSBool *hole,
         *hole = JS_FALSE;
         return JS_TRUE;
     }
+    if (obj->isArguments() &&
+        index < obj->getArgsInitialLength() &&
+        !(*vp = obj->getArgsElement(uint32(index))).isMagic(JS_ARRAY_HOLE)) {
+        *hole = JS_FALSE;
+        JSStackFrame *fp = (JSStackFrame *)obj->getPrivate();
+        if (fp != JS_ARGUMENTS_OBJECT_ON_TRACE) {
+            if (fp)
+                *vp = fp->canonicalActualArg(index);
+            return JS_TRUE;
+        }
+    }
 
     AutoIdRooter idr(cx);
 
