From 39bebc75cdc2418789f82770200d38eeacce0275 Mon Sep 17 00:00:00 2001
From: Ivan Ristic <ivanr@webkreator.com>
Date: Wed, 9 Jan 2013 16:00:20 +0000
Subject: [PATCH] Fix memory leak when processing 100 responses.

---
 htp/htp_response.c | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/htp/htp_response.c b/htp/htp_response.c
index 86bf4603..c860b3f5 100644
--- a/htp/htp_response.c
+++ b/htp/htp_response.c
@@ -255,10 +255,18 @@ htp_status_t htp_connp_RES_BODY_DETERMINE(htp_connp_t *connp) {
             return HTP_ERROR;
         }
 
-        // Ignore any response headers set
-        // XXX Is all the memory correctly freed here?
+        // Ignore any response headers seen so far.
+        htp_header_t *h = NULL;
+        for (int i = 0, n = htp_table_size(connp->out_tx->response_headers); i < n; i++) {
+            htp_table_get_index(connp->out_tx->response_headers, i, NULL, (void **) &h);
+            bstr_free(&h->name);
+            bstr_free(&h->value);
+            free(h);
+        }
+
         htp_table_clear(connp->out_tx->response_headers);
 
+        // Expecting to see another response line next.
         connp->out_state = htp_connp_RES_LINE;
         connp->out_tx->progress = HTP_RESPONSE_LINE;
         connp->out_tx->seen_100continue++;
