From 9b83ce2945dc21aa0cbd9e53cd9b2f71877c315b Mon Sep 17 00:00:00 2001
From: = <675973885@qq.com>
Date: Wed, 29 Jun 2016 20:51:25 -0400
Subject: [PATCH] Use exchange() instead of CAS in PreparePush()

---
 src/atomic_stack.h | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/atomic_stack.h b/src/atomic_stack.h
index d22f256..eecc71c 100644
--- a/src/atomic_stack.h
+++ b/src/atomic_stack.h
@@ -200,6 +200,7 @@ class AtomicStack {
    * The return value is the stack top before switching it to nullptr
    */
   inline VersionedPointer<T> PreparePush() {
+    /*
     bool cas_ret;
 
     // If CAS fails this value would be automatically reloaded
@@ -218,6 +219,14 @@ class AtomicStack {
                                               nullptr);
     } while(cas_ret == false);
 
+    return snapshot_top_p;
+    */
+    VersionedPointer<T> snapshot_top_p = top_p.exchange(nullptr);
+    
+    #ifdef BWTREE_DEBUG
+    assert((snapshot_top_p - data + 1) < STACK_SIZE);
+    #endif
+    
     return snapshot_top_p;
   }
 
