From d6f3d35bc2d59d39a5eb7011f4b027673412b2fa Mon Sep 17 00:00:00 2001
From: mxmlnkn <mxmlnkn@github.de>
Date: Sun, 4 Feb 2024 12:47:46 +0100
Subject: [PATCH] [performance] Do not compress windows during index import:
 13.5 -> 5.2 s

time src/tools/rapidgzip -P 24 --count --import-index wikidata-20220103-all.json.gz{.index,}

After: 5.199 5.083 5.182 5.215
Before: 13.722 13.702 13.481 13.751

Note that this increases PeakRSS again!
---
 src/rapidgzip/IndexFileFormat.hpp | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/rapidgzip/IndexFileFormat.hpp b/src/rapidgzip/IndexFileFormat.hpp
index c8de3a8d..fe9461ae 100644
--- a/src/rapidgzip/IndexFileFormat.hpp
+++ b/src/rapidgzip/IndexFileFormat.hpp
@@ -462,8 +462,7 @@ readGzipIndex( UniqueFileReader         indexFile,
         }
 
         /* Only bother with overhead-introducing compression for large chunk compression ratios. */
-        index.windows->emplace( offset, std::move( window ),
-                                compressionRatio > 2 ? CompressionType::GZIP : CompressionType::NONE );
+        index.windows->emplace( offset, std::move( window ), CompressionType::NONE );
     }
 
     return index;
