From 763e6a5d4837d350fcb6d74fc6289deb2e7fa389 Mon Sep 17 00:00:00 2001
From: rtayl <rtayl@amd.com>
Date: Fri, 26 Jul 2019 17:12:48 -0400
Subject: [PATCH] Add !invariant.load to load descriptor sets

This adds the !invariant.load metadata to load descriptor sets
in order for opts like cse to better optimize these loads

Add !invariant.load to load descriptor sets

This adds the !invariant.load metadata to load descriptor sets
in order for opts like cse to better optimize these loads
---
 patch/llpcPatchDescriptorLoad.cpp | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/patch/llpcPatchDescriptorLoad.cpp b/patch/llpcPatchDescriptorLoad.cpp
index 4a5331525b..8dd3bb0b99 100644
--- a/patch/llpcPatchDescriptorLoad.cpp
+++ b/patch/llpcPatchDescriptorLoad.cpp
@@ -635,6 +635,8 @@ Value* PatchDescriptorLoad::LoadDescriptor(
             // Load descriptor
             pCastedDescPtr->setMetadata(m_pContext->MetaIdUniform(), m_pContext->GetEmptyMetadataNode());
             pDesc = new LoadInst(pCastedDescPtr, "", pInsertPoint);
+            if (LoadInst *LI = dyn_cast<LoadInst>(pDesc))
+              LI->setMetadata(m_pContext->MetaIdInvariantLoad(), m_pContext->GetEmptyMetadataNode());
             cast<LoadInst>(pDesc)->setAlignment(16);
         }
     }
