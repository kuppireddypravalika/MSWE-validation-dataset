From af267e24a2fbfb04c4ef669d872195746ddd32d5 Mon Sep 17 00:00:00 2001
From: Anthony Jones <ajones@mozilla.com>
Date: Wed, 29 Aug 2012 17:00:09 -0400
Subject: [PATCH] Bug 781731 - Fix Azure Cairo GTK perf by removing xlib to
 buffered image conversion. r=Bas

---
 gfx/thebes/gfxPlatform.cpp | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/gfx/thebes/gfxPlatform.cpp b/gfx/thebes/gfxPlatform.cpp
index 7e7e4bf1329..8ec7dfa15d0 100644
--- a/gfx/thebes/gfxPlatform.cpp
+++ b/gfx/thebes/gfxPlatform.cpp
@@ -535,8 +535,21 @@ gfxPlatform::GetSourceSurfaceForSurface(DrawTarget *aTarget, gfxASurface *aSurfa
       dt->Flush();
     }
     srcBuffer = aTarget->CreateSourceSurfaceFromNativeSurface(surf);
-  }
+  } else
 #endif
+  if (aSurface->CairoSurface()) {
+    // If this is an xlib cairo surface we don't want to fetch it into memory
+    // because this is a major slow down.
+    NativeSurface surf;
+    surf.mFormat = format;
+    surf.mType = NATIVE_SURFACE_CAIRO_SURFACE;
+    surf.mSurface = aSurface->CairoSurface();
+    srcBuffer = aTarget->CreateSourceSurfaceFromNativeSurface(surf);
+
+    // It's cheap enough to make a new one so we won't keep it around and
+    // keeping it creates a cycle.
+    return srcBuffer;
+  }
 
   if (!srcBuffer) {
     nsRefPtr<gfxImageSurface> imgSurface = aSurface->GetAsImageSurface();
