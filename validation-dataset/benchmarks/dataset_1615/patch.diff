From d4fdf5cadb63f11916d20e45d28807668b0355d4 Mon Sep 17 00:00:00 2001
From: Neil Coggins <neac@havenprotocol.org>
Date: Wed, 15 May 2024 10:45:52 +0100
Subject: [PATCH] changed xUSD MCAP calculation to use min(spot/ma) instead of
 true MCAP value

---
 src/cryptonote_core/cryptonote_tx_utils.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/cryptonote_core/cryptonote_tx_utils.cpp b/src/cryptonote_core/cryptonote_tx_utils.cpp
index b71e304e1..d34b14468 100644
--- a/src/cryptonote_core/cryptonote_tx_utils.cpp
+++ b/src/cryptonote_core/cryptonote_tx_utils.cpp
@@ -809,7 +809,7 @@ namespace cryptonote
       // Calculate the xUSD Mcap
       cpp_bin_float_quad mcap_xusd = map_amounts["xUSD"].convert_to<cpp_bin_float_quad>();
       mcap_xusd *= COIN;
-      mcap_xusd /= pr.spot("xUSD");
+      mcap_xusd /= std::min(pr.spot("xUSD"), pr.ma("xUSD"));
 
       // Update the xBTC Mcap Ratio Slippage
       xbtc_mcap_ratio_slippage = std::sqrt(std::pow((mcap_xbtc / mcap_xusd).convert_to<double>(), 1.4)) / 10.0;
