From bbe21b925387b0878552fa37dee7b42cb8fdcc8e Mon Sep 17 00:00:00 2001
From: Klaus Iglberger <klaus.iglberger@gmail.com>
Date: Thu, 6 Mar 2014 10:03:34 +0100
Subject: [PATCH] Improve the performance of the intrinsic double precision
 'sum' function for the AVX instruction set

---
 blaze/math/intrinsics/Reduction.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/blaze/math/intrinsics/Reduction.h b/blaze/math/intrinsics/Reduction.h
index 410070b04..adcdb5c88 100644
--- a/blaze/math/intrinsics/Reduction.h
+++ b/blaze/math/intrinsics/Reduction.h
@@ -152,7 +152,9 @@ inline double sum( const sse_double_t& a )
    return _mm512_reduce_add_pd( a.value );
 #elif BLAZE_AVX_MODE
    const sse_double_t b( _mm256_hadd_pd( a.value, a.value ) );
-   return b[0] + b[2];
+   const __m128d c = _mm_add_pd( _mm256_extractf128_pd( b.value, 1 )
+                               , _mm256_castpd256_pd128( b.value ) );
+   return *reinterpret_cast<const double*>( &c );
 #elif BLAZE_SSE3_MODE
    const sse_double_t b( _mm_hadd_pd( a.value, a.value ) );
    return b[0];
