From 1d0334e701a6a4b3e71552ad964e173abf4ace86 Mon Sep 17 00:00:00 2001
From: Sebastian Herholz <sebastian.herholz@intel.com>
Date: Fri, 22 Jul 2022 12:01:32 +0200
Subject: [PATCH] [vmm] Optimized cosine product

Avoid on-the-fly calculation of the normalization for the VMM cosine lobe
---
 openpgl/directional/vmm/VMMSurfaceSamplingDistribution.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/openpgl/directional/vmm/VMMSurfaceSamplingDistribution.h b/openpgl/directional/vmm/VMMSurfaceSamplingDistribution.h
index e29b86b..fbfecaa 100644
--- a/openpgl/directional/vmm/VMMSurfaceSamplingDistribution.h
+++ b/openpgl/directional/vmm/VMMSurfaceSamplingDistribution.h
@@ -49,9 +49,11 @@ struct VMMSurfaceSamplingDistribution: public ISurfaceSamplingDistribution
 
     inline void applyCosineProduct(const Vector3& normal) override
     {
+        const float cosine_kappa = 2.18853f;
+        const float cosine_normalization = 2.18853f/(2.0f*M_PI*(1.0f-std::exp(-2.0f * 2.18853f)));
         if(this->m_numDistributions > 0)
         {
-            this->m_productIntegral = this->m_distributions[0].product(1.0f, normal, 2.18853f);
+            this->m_productIntegral = this->m_distributions[0].product(1.0f, normal, cosine_kappa, cosine_normalization);
         }
     }
 
