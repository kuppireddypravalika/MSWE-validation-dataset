From 701302cfdbb703523640b89acd7153ee9dd9a0d3 Mon Sep 17 00:00:00 2001
From: Max Pietsch <mail@maxpietsch.com>
Date: Thu, 26 Nov 2015 11:34:52 +0000
Subject: [PATCH] FLUSH_TO_ZERO added option for flush denormals to zero which
 increases speed of calculations close to zero. This speeds up the cubic
 hermite spline interpolator on my intel CPU by a factor of 20 if the voxel()
 method is called with voxel locations that are close (i.e. 1.0e-14) but not
 extremely close (i.e. 1.0e-30) to the voxel grid. This will likely affect the
 precision of calculations close to zero.

---
 lib/command.h | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/lib/command.h b/lib/command.h
index 632e66ac79..fc52dd6e7f 100644
--- a/lib/command.h
+++ b/lib/command.h
@@ -24,6 +24,7 @@
 #define __command_h__
 
 
+#include <xmmintrin.h>
 #include "project_version.h"
 #include "app.h"
 
@@ -71,7 +72,16 @@ extern "C" void R_usage (char** output)
 #else
 
 int main (int cmdline_argc, char** cmdline_argv) 
-{ 
+{
+#ifdef FLUSH_TO_ZERO
+  // use gcc switches: -msse -mfpmath=sse -ffast-math
+  int mxcsr = _mm_getcsr ();
+  // Sets denormal results from floating-point calculations to zero:
+  mxcsr |= (1<<15) | (1<<11); // flush-to-zero
+  // Treats denormal values used as input to floating-point instructions as zero:
+  mxcsr |= (1<<6); // denormals-are-zero
+  _mm_setcsr (mxcsr);
+#endif
   ::MR::App::build_date = __DATE__; 
 #ifdef MRTRIX_PROJECT_VERSION
   ::MR::App::project_version = MRTRIX_PROJECT_VERSION;
