From 9ac36c7ee9e7464614b0702d9cfcbba26b44bfef Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Fri, 16 Mar 2018 14:48:27 +0000
Subject: [PATCH] RRASTER: avoid excessive memory allocation attempt. Fixes
 https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=6967. Credit to OSS
 Fuzz

git-svn-id: https://svn.osgeo.org/gdal/trunk@41824 f0d54148-0727-0410-94bb-9a71ac55c965
---
 gdal/frmts/raw/rrasterdataset.cpp | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/gdal/frmts/raw/rrasterdataset.cpp b/gdal/frmts/raw/rrasterdataset.cpp
index 0d956a9a9994..b13aa448e7d8 100644
--- a/gdal/frmts/raw/rrasterdataset.cpp
+++ b/gdal/frmts/raw/rrasterdataset.cpp
@@ -1209,6 +1209,15 @@ GDALDataset *RRASTERDataset::Open( GDALOpenInfo * poOpenInfo )
         return nullptr;
     }
 
+    if( !RAWDatasetCheckMemoryUsage(
+                        nCols, nRows, l_nBands,
+                        nPixelOffset, nLineOffset, 0, nBandOffset,
+                        fpImage) )
+    {
+        VSIFCloseL(fpImage);
+        return nullptr;
+    }
+
     RRASTERDataset* poDS = new RRASTERDataset;
     poDS->eAccess = poOpenInfo->eAccess;
     poDS->nRasterXSize = nCols;
