From 6886d8ff65324ac9f17073c88748fe5079793e81 Mon Sep 17 00:00:00 2001
From: Ryan Houdek <Sonicadvance1@gmail.com>
Date: Mon, 5 Dec 2022 02:58:15 -0800
Subject: [PATCH] FEXLoader: Make `IsInterpreterInstalled` check less horrible.

`std::filesystem::exists` is particularly gnarly in how it checks to see
if the file exists.
It allocates memory, it creates lists, it splits things, then eventually
checking the status

Remove all this overhead to help out minorly for applications that
execve a lot.
---
 Source/Tests/FEXLoader.cpp | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/Source/Tests/FEXLoader.cpp b/Source/Tests/FEXLoader.cpp
index 6aff03b7d4..e2d7086660 100644
--- a/Source/Tests/FEXLoader.cpp
+++ b/Source/Tests/FEXLoader.cpp
@@ -191,10 +191,9 @@ bool IsInterpreterInstalled() {
   // The interpreter is installed if both the binfmt_misc handlers are available
   // Or if we were originally executed with FD. Which means the interpreter is installed
 
-  std::error_code ec{};
   return ExecutedWithFD ||
-         (std::filesystem::exists("/proc/sys/fs/binfmt_misc/FEX-x86", ec) &&
-         std::filesystem::exists("/proc/sys/fs/binfmt_misc/FEX-x86_64", ec));
+         (access("/proc/sys/fs/binfmt_misc/FEX-x86", F_OK) == 0 &&
+          access("/proc/sys/fs/binfmt_misc/FEX-x86_64", F_OK) == 0);
 }
 
 int main(int argc, char **argv, char **const envp) {
