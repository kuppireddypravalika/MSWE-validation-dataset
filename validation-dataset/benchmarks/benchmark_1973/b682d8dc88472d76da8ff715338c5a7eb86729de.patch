From b682d8dc88472d76da8ff715338c5a7eb86729de Mon Sep 17 00:00:00 2001
From: Folkert van Heusden <folkert@zarafa.com>
Date: Thu, 24 Sep 2015 12:11:50 +0200
Subject: [PATCH] common: replace "select" by "poll"

References: ZCP-13065
---
 common/ECChannel.cpp | 14 +++-----------
 1 file changed, 3 insertions(+), 11 deletions(-)

diff --git a/common/ECChannel.cpp b/common/ECChannel.cpp
index cbd291bf4..b80c57afc 100644
--- a/common/ECChannel.cpp
+++ b/common/ECChannel.cpp
@@ -22,8 +22,8 @@
 #include <kopano/stringutil.h>
 #include <csignal>
 #include <netdb.h>
+#include <poll.h>
 #include <sys/types.h>
-#include <sys/select.h>
 #include <sys/socket.h>
 #include <sys/stat.h>
 #include <sys/un.h>
@@ -486,19 +486,11 @@ HRESULT ECChannel::HrReadBytes(std::string * strBuffer, ULONG ulByteCount) {
 }
 
 HRESULT ECChannel::HrSelect(int seconds) {
-	fd_set fds;
-	int res = 0;
-	struct timeval timeout = { seconds, 0 };
+	struct pollfd pollfd = {fd, POLLIN | POLLRDHUP, 0};
 
-	if(fd >= FD_SETSIZE)
-	    return MAPI_E_NOT_ENOUGH_MEMORY;
 	if(lpSSL && SSL_pending(lpSSL))
 		return hrSuccess;
-
-	FD_ZERO(&fds);
-	FD_SET(fd, &fds);
-
-	res = select(fd + 1, &fds, NULL, NULL, &timeout);
+	int res = poll(&pollfd, 1, seconds * 1000);
 	if (res == -1) {
 		if (errno == EINTR)
 			/*
