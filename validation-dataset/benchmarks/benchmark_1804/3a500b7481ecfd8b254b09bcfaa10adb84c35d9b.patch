From 3a500b7481ecfd8b254b09bcfaa10adb84c35d9b Mon Sep 17 00:00:00 2001
From: Ben S <bsikora906@gmail.com>
Date: Mon, 18 Apr 2016 17:58:52 -0400
Subject: [PATCH] Switched to atan2 method to calculate theta in TorsionalCV

---
 src/CVs/TorsionalCV.h | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/src/CVs/TorsionalCV.h b/src/CVs/TorsionalCV.h
index 690cd316..24538b12 100644
--- a/src/CVs/TorsionalCV.h
+++ b/src/CVs/TorsionalCV.h
@@ -188,9 +188,24 @@ namespace SSAGES
 
 			_val = acos(DotProduct(rim, rln)/(normrim*normrln));
 			std::cout<<_val<<std::endl;
-			std::cout<<DotProduct(rim,rln)/(normrim*normrln)<<std::endl;
-			std::cout<<DotProduct(rim,rln)<<" "<<normrim<<" "<<normrln<<std::endl;
-				
+
+			auto rmj = CrossProduct(rij,rkj);
+			auto rnk = CrossProduct(rkj,rkl);
+			auto normkj = norm(rkj);
+			auto normmj = norm(rmj);
+			auto normnk = norm(rnk);
+			Vector3 rijrkjprod;
+			for(size_t i = 0; i < rijrkjprod.size();i++)
+				rijrkjprod[i] = rij[i]*normkj;
+			auto rkjrklcross = CrossProduct(rkj, rkl);
+			auto y = DotProduct(rijrkjprod, rkjrklcross);
+			auto rijrkjcross = CrossProduct(rij, rkj);
+			auto x = DotProduct(rijrkjcross, rkjrklcross);
+			auto theta = atan2(y, x);
+
+			_val = theta;
+			std::cout<<theta<<std::endl;
+
 			Vector3 d0dri, d0drj, d0drk, d0drl;
 
 			for(size_t i = 0; i<3; i++)
