From 8e2ab134a2e79e106f672566959b493dcaadf9d5 Mon Sep 17 00:00:00 2001
From: David Atienza <daries100@gmail.com>
Date: Thu, 19 Aug 2021 19:11:56 +0200
Subject: [PATCH] Improved tolerance of is_psd() function following the
 guidelines of numpy in np.linalg.matrix_rank().

---
 pybnesian/util/basic_eigen_ops.hpp | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/pybnesian/util/basic_eigen_ops.hpp b/pybnesian/util/basic_eigen_ops.hpp
index 9833c962..a5e89f69 100644
--- a/pybnesian/util/basic_eigen_ops.hpp
+++ b/pybnesian/util/basic_eigen_ops.hpp
@@ -137,7 +137,9 @@ bool is_psd(const M& m) {
     using MatrixType = Matrix<typename M::Scalar, Dynamic, Dynamic>;
     Eigen::SelfAdjointEigenSolver<MatrixType> eigen_solver(m, Eigen::EigenvaluesOnly);
 
-    if (eigen_solver.eigenvalues().minCoeff() < util::machine_tol) {
+    auto tol = eigen_solver.eigenvalues().maxCoeff() * m.rows() * std::numeric_limits<typename M::Scalar>::epsilon();
+
+    if (eigen_solver.eigenvalues().minCoeff() < tol) {
         return false;
     }
 
