From 5ae687357e0fb58ba516fa0a2055fbe196315c27 Mon Sep 17 00:00:00 2001
From: Hendrik Leppkes <h.leppkes@gmail.com>
Date: Sat, 12 Mar 2016 11:07:42 +0100
Subject: [PATCH] Properly signal doubled fps in initial media type when using
 w3fdif

---
 decoder/LAVVideo/LAVVideo.cpp | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/decoder/LAVVideo/LAVVideo.cpp b/decoder/LAVVideo/LAVVideo.cpp
index 5c5d704e6..0fd77b73e 100644
--- a/decoder/LAVVideo/LAVVideo.cpp
+++ b/decoder/LAVVideo/LAVVideo.cpp
@@ -542,13 +542,17 @@ HRESULT CLAVVideo::GetMediaType(int iPosition, CMediaType *pMediaType)
   CMediaType &mtIn = m_pInput->CurrentMediaType();
 
   BITMAPINFOHEADER *pBIH = nullptr;
-  REFERENCE_TIME rtAvgTime;
+  REFERENCE_TIME rtAvgTime = 0;
   DWORD dwAspectX = 0, dwAspectY = 0;
   videoFormatTypeHandler(mtIn.Format(), mtIn.FormatType(), &pBIH, &rtAvgTime, &dwAspectX, &dwAspectY);
 
   // Adjust for deinterlacing
-  if (m_Decoder.IsInterlaced() && m_settings.SWDeintMode != SWDeintMode_None && m_settings.SWDeintOutput == DeintOutput_FramePerField && !(m_settings.DeintMode == DeintMode_Disable))
-    rtAvgTime /= 2;
+  if (m_Decoder.IsInterlaced() && m_settings.DeintMode != DeintMode_Disable) {
+    BOOL bFramePerField = (m_settings.SWDeintMode == SWDeintMode_YADIF && m_settings.SWDeintOutput == DeintOutput_FramePerField)
+                        || m_settings.SWDeintMode == SWDeintMode_W3FDIF_Simple || m_settings.SWDeintMode == SWDeintMode_W3FDIF_Complex;
+    if (bFramePerField)
+      rtAvgTime /= 2;
+  }
 
   m_PixFmtConverter.GetMediaType(pMediaType, index, pBIH->biWidth, pBIH->biHeight, dwAspectX, dwAspectY, rtAvgTime, IsInterlaced(), bVIH1);
 
