From ad9340de99a9961a8d34c7e430638a7c01c3d2be Mon Sep 17 00:00:00 2001
From: Anton Kudryavtsev <a.kudryavtsev@netris.ru>
Date: Wed, 17 Feb 2016 12:26:43 +0300
Subject: [PATCH] QListView: avoid quadratic complexity in selectedIndexes().

Use std::remove_if(), which is linear, instead of looping
over erase(it), which turns the loop quadratic.

Reorder condition: call cheap non-virtual QModelIndex::column()
first, then virtuals parent(), and isIndexHidden().

Change-Id: Id46ee1297b91906332eeca98f69372ef887ac330
Reviewed-by: Marc Mutz <marc.mutz@kdab.com>
Reviewed-by: Edward Welbourne <edward.welbourne@theqtcompany.com>
---
 src/widgets/itemviews/qlistview.cpp | 12 +++++-------
 1 file changed, 5 insertions(+), 7 deletions(-)

diff --git a/src/widgets/itemviews/qlistview.cpp b/src/widgets/itemviews/qlistview.cpp
index 8e4d94d2f031..646ab58e3d69 100644
--- a/src/widgets/itemviews/qlistview.cpp
+++ b/src/widgets/itemviews/qlistview.cpp
@@ -1440,13 +1440,11 @@ QModelIndexList QListView::selectedIndexes() const
         return QModelIndexList();
 
     QModelIndexList viewSelected = d->selectionModel->selectedIndexes();
-    for (int i = 0; i < viewSelected.count();) {
-        const QModelIndex &index = viewSelected.at(i);
-        if (!isIndexHidden(index) && index.parent() == d->root && index.column() == d->column)
-            ++i;
-        else
-            viewSelected.removeAt(i);
-    }
+    auto ignorable = [this, d](const QModelIndex &index) {
+        return index.column() != d->column || index.parent() != d->root || isIndexHidden(index);
+    };
+    viewSelected.erase(std::remove_if(viewSelected.begin(), viewSelected.end(), ignorable),
+                       viewSelected.end());
     return viewSelected;
 }
 
