From 580b5c4f609941fac69db6e7ca6adfcd8a738ea2 Mon Sep 17 00:00:00 2001
From: MITSUNARI Shigeo <herumi@nifty.com>
Date: Tue, 28 Aug 2012 09:55:06 +0900
Subject: [PATCH] a little optimization of rank

---
 rank_comp.hpp | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

diff --git a/rank_comp.hpp b/rank_comp.hpp
index b88872a..6880a50 100644
--- a/rank_comp.hpp
+++ b/rank_comp.hpp
@@ -528,12 +528,8 @@ class SBV6 {
 		ret += popCount64(b1 & m1);
 #if 1
 #if 1
-		V128 vmask;
-		vmask = pcmpeqd(vmask, vmask); // all [-1]
-		V128 shift((8 - q) * 8);
-		vmask = psrlq(vmask, shift);
-		V128 v(blk.ci.s);
-		v = pand(v, vmask);
+		uint32_t x = blk.ci.s & ((1U << (q * 8)) - 1);
+		V128 v(x);
 		v = psadbw(v, Zero());
 		ret += movd(v);
 #else
