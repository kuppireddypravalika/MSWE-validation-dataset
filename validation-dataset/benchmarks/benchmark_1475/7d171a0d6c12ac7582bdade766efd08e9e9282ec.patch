From 7d171a0d6c12ac7582bdade766efd08e9e9282ec Mon Sep 17 00:00:00 2001
From: Mark Satterthwaite <Mark.Satterthwaite@epicgames.com>
Date: Mon, 14 Sep 2015 10:09:27 -0400
Subject: [PATCH] Prevent clang/ld from dead-code-eliminating the nothrow_t
 variants of global new on OS X to stop some of the older code in OS X from
 allocating from the system heap but deleting via our overrides, which causes
 memory errors. Spotted by Address Sanitiser in UE4-Fortnite.

[CL 2690187 by Mark Satterthwaite in Main branch]
---
 .../Runtime/Core/Private/Mac/MacPlatformMisc.cpp      | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/Engine/Source/Runtime/Core/Private/Mac/MacPlatformMisc.cpp b/Engine/Source/Runtime/Core/Private/Mac/MacPlatformMisc.cpp
index 16d1598134c..06cc79af3f0 100644
--- a/Engine/Source/Runtime/Core/Private/Mac/MacPlatformMisc.cpp
+++ b/Engine/Source/Runtime/Core/Private/Mac/MacPlatformMisc.cpp
@@ -43,6 +43,17 @@ struct FMacApplicationInfo
 	{
 		SCOPED_AUTORELEASE_POOL;
 		
+		// Prevent clang/ld from dead-code-eliminating the nothrow_t variants of global new.
+		// This ensures that all OS calls to operator new go through our allocators and delete cleanly.
+		{
+			std::nothrow_t t;
+			char* d = (char*)(operator new(8, t));
+			delete d;
+			
+			d = (char*)operator new[]( 8, t );
+			delete [] d;
+		}
+		
 		AppName = FApp::GetGameName();
 		FCStringAnsi::Strcpy(AppNameUTF8, PATH_MAX+1, TCHAR_TO_UTF8(*AppName));
 		
