From 17d9c1708b5afe32c362fdaba114e74f64a7dd06 Mon Sep 17 00:00:00 2001
From: Max Kellermann <max@duempel.org>
Date: Fri, 10 Oct 2008 16:47:57 +0200
Subject: [PATCH] player: don't wake up decoder after every frame

The decoder was woken up after each chunk which had been played.  That
caused a lot of superfluous context switches.  Wake up the decoder
only when a certain amount of the buffer has been consumed.  This
formula is somewhat arbitrary, and has to be proven experimentally.
---
 src/player_thread.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/player_thread.c b/src/player_thread.c
index c5a51a00a2..b82005aecf 100644
--- a/src/player_thread.c
+++ b/src/player_thread.c
@@ -339,7 +339,13 @@ static void do_play(void)
 				      sizeToTime) < 0)
 				break;
 			ob_shift();
-			notify_signal(&dc.notify);
+
+			/* this formula should prevent that the
+			   decoder gets woken up with each chunk; it
+			   is more efficient to make it decode a
+			   larger block at a time */
+			if (ob_available() <= (pc.buffered_before_play + ob.size * 3) / 4)
+				notify_signal(&dc.notify);
 		} else if (!ob_is_empty() && (int)ob.begin == next) {
 			/* at the beginning of a new song */
 
