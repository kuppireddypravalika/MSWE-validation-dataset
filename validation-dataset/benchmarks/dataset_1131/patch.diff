From 25f127b08cbba08ce3e65cfe94dae1756b6e79d5 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Fri, 20 Nov 2015 13:13:34 +0000
Subject: [PATCH] Block cache: fix excessive memory consumption when dealing
 with datasets with different block sizes
 (https://trac.osgeo.org/gdal/ticket/6226)

git-svn-id: https://svn.osgeo.org/gdal/trunk@31656 f0d54148-0727-0410-94bb-9a71ac55c965
---
 gdal/gcore/gdalrasterblock.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/gdal/gcore/gdalrasterblock.cpp b/gdal/gcore/gdalrasterblock.cpp
index 324535e5e863..4233376b0c82 100644
--- a/gdal/gcore/gdalrasterblock.cpp
+++ b/gdal/gcore/gdalrasterblock.cpp
@@ -857,7 +857,7 @@ CPLErr GDALRasterBlock::Internalize()
                     }
                     if( nBlocksToFree == 64 )
                     {
-                        CPLDebug("GDAL", "More than 64 blocks are flagged to be flushed. Not trying more");
+                        bLoopAgain = ( nCacheUsed > nCurCacheMax );
                         break;
                     }
 
@@ -894,7 +894,7 @@ CPLErr GDALRasterBlock::Internalize()
             /* Try to recycle the data of an existing block */
             void* pDataBlock = poBlock->pData;
             if( pNewData == NULL && pDataBlock != NULL &&
-                poBlock->GetBlockSize() >= nSizeInBytes )
+                poBlock->GetBlockSize() == nSizeInBytes )
             {
                 pNewData = pDataBlock;
             }
