From 396f7ec5c19dd4c173e9dc707de1df230a6acd1a Mon Sep 17 00:00:00 2001
From: Alexander Grund <Flamefire@users.noreply.github.com>
Date: Sun, 30 Jan 2022 16:56:34 +0100
Subject: [PATCH] Copy map via filesystem when hosting a game

The direct copy is much faster than the copy via the network connection that would otherwise be required.
---
 libs/s25main/network/GameClient.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/libs/s25main/network/GameClient.cpp b/libs/s25main/network/GameClient.cpp
index 08004830eb..5c26869e93 100644
--- a/libs/s25main/network/GameClient.cpp
+++ b/libs/s25main/network/GameClient.cpp
@@ -114,6 +114,13 @@ bool GameClient::Connect(const std::string& server, const std::string& password,
 bool GameClient::HostGame(const CreateServerInfo& csi, const boost::filesystem::path& map_path, MapType map_type)
 {
     std::string hostPw = createRandString(20);
+    // Copy the map to the played map folders to avoid having to transmit it from the (local) server
+    const auto playedMapPath = RTTRCONFIG.ExpandPath(s25::folders::mapsPlayed) / map_path.filename();
+    if(playedMapPath != map_path)
+    {
+        boost::system::error_code ignoredEc;
+        copy_file(map_path, playedMapPath, boost::filesystem::copy_option::overwrite_if_exists, ignoredEc);
+    }
     return GAMESERVER.Start(csi, map_path, map_type, hostPw)
            && Connect("localhost", hostPw, csi.type, csi.port, true, csi.ipv6);
 }
