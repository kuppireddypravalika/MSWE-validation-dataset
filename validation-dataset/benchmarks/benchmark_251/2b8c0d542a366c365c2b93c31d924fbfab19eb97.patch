From 2b8c0d542a366c365c2b93c31d924fbfab19eb97 Mon Sep 17 00:00:00 2001
From: Daniel Kolesa <daniel@octaforge.org>
Date: Sun, 1 Mar 2020 19:16:18 +0100
Subject: [PATCH] use libffi type size with memcpy to deal with large types

---
 src/main.cc | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/main.cc b/src/main.cc
index 3fd9ba5..278ffaf 100644
--- a/src/main.cc
+++ b/src/main.cc
@@ -318,10 +318,9 @@ struct ctype_meta {
                 cd.val.cd->fref = fref;
             }
         } else {
-            /* FIXME: allocations of large cdata */
             auto *cd = lua::newuserdata<ffi::cdata<ast::c_value>>(L);
             new (&cd->decl) ast::c_type{decl};
-            memcpy(&cd->val, cdp, sizeof(ast::c_value));
+            memcpy(&cd->val, cdp, cd->decl.libffi_type()->size);
             luaL_setmetatable(L, "cffi_cdata_handle");
         }
         return 1;
