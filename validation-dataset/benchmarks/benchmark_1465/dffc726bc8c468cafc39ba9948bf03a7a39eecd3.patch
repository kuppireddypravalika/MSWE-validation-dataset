From dffc726bc8c468cafc39ba9948bf03a7a39eecd3 Mon Sep 17 00:00:00 2001
From: Sainan <63328889+Sainan@users.noreply.github.com>
Date: Sun, 21 Aug 2022 08:26:49 +0200
Subject: [PATCH] Optimise IDIV by power of 2

---
 src/lcode.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/lcode.cpp b/src/lcode.cpp
index f571db53b..ba1f7e260 100644
--- a/src/lcode.cpp
+++ b/src/lcode.cpp
@@ -1701,6 +1701,13 @@ void luaK_posfix (FuncState *fs, BinOpr opr,
         }
         break;
       }
+      case OPR_IDIV: {
+        if (e2->k == VKINT && luaispow2(e2->u.ival)) { /* IDIV by a constant power of 2? */
+          opr = OPR_SHR;
+          e2->u.ival = (lua_Integer)log2((double)e2->u.ival);
+        }
+        break;
+      }
     }
   }
   switch (opr) { /* finalise code */
