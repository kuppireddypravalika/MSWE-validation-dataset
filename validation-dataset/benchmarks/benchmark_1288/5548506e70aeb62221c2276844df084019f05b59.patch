From 5548506e70aeb62221c2276844df084019f05b59 Mon Sep 17 00:00:00 2001
From: Chris Lattner <sabre@nondot.org>
Date: Fri, 7 Nov 2003 23:56:01 +0000
Subject: [PATCH] Do not use operator new to allocate the vector.  This adds a
 pointless dependency on libstdc++

git-svn-id: https://llvm.org/svn/llvm-project/poolalloc/trunk@9797 91177308-0d34-0410-b5e6-96231b3b80d8
---
 runtime/PoolAllocator/PageManager.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/runtime/PoolAllocator/PageManager.cpp b/runtime/PoolAllocator/PageManager.cpp
index 1324218b..3d84bfbd 100644
--- a/runtime/PoolAllocator/PageManager.cpp
+++ b/runtime/PoolAllocator/PageManager.cpp
@@ -25,7 +25,8 @@ unsigned PageSize = 0;
 
 // Explicitly use the malloc allocator here, to avoid depending on the C++
 // runtime library.
-static std::vector<void*, MallocAllocator<void*> > *FreePages = 0;
+typedef std::vector<void*, MallocAllocator<void*> > FreePagesListType;
+static FreePagesListType *FreePages = 0;
 
 void InitializePageManager() {
   if (!PageSize) PageSize = sysconf(_SC_PAGESIZE);
@@ -70,7 +71,12 @@ void *AllocatePage() {
   unsigned NumToAllocate = 10;
   char *Ptr = (char*)GetPages(NumToAllocate);
 
-  if (!FreePages) FreePages = new std::vector<void*, MallocAllocator<void*> >();
+  if (!FreePages) {
+    // Avoid using operator new!
+    FreePages = (FreePagesListType*)malloc(sizeof(FreePagesListType));
+    // Use placement new now.
+    new (FreePages) std::vector<void*, MallocAllocator<void*> >();
+  }
   for (unsigned i = 1; i != NumToAllocate; ++i)
     FreePages->push_back(Ptr+i*PageSize);
   return Ptr;
