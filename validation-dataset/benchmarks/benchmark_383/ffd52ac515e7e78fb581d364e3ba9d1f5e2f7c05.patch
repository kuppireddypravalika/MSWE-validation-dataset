From ffd52ac515e7e78fb581d364e3ba9d1f5e2f7c05 Mon Sep 17 00:00:00 2001
From: Philippe Canal <pcanal@fnal.gov>
Date: Mon, 24 Feb 2014 13:20:09 -0600
Subject: [PATCH] In TThread::Self avoid linear search.

Use local thread storage to avoid having
to search through the whole list of TThread object.
---
 core/thread/src/TThread.cxx | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/core/thread/src/TThread.cxx b/core/thread/src/TThread.cxx
index b3141debdeb3a..f4644e85e48ca 100644
--- a/core/thread/src/TThread.cxx
+++ b/core/thread/src/TThread.cxx
@@ -33,6 +33,7 @@
 #include "TInterpreter.h"
 #include "TError.h"
 #include "Varargs.h"
+#include "ThreadLocalStorage.h"
 
 TThreadImp     *TThread::fgThreadImp = 0;
 Long_t          TThread::fgMainId = 0;
@@ -449,7 +450,10 @@ TThread *TThread::Self()
 {
    // Static method returning pointer to current thread.
 
-   return GetThread(SelfId());
+   static TTHREAD_TLS(TThread*) self = 0;
+
+   if (!self) self = GetThread(SelfId());
+   return self;
 }
 
 
