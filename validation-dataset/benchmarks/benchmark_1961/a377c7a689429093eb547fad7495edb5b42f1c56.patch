From a377c7a689429093eb547fad7495edb5b42f1c56 Mon Sep 17 00:00:00 2001
From: emoose <abc@cock.li>
Date: Sat, 10 Aug 2024 16:17:21 +0100
Subject: [PATCH] idaloader: make use of ea_helper_t & set image base address

Thanks to camden-smallwood for ea_helper_t suggestion!
---
 idaloader.cpp | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/idaloader.cpp b/idaloader.cpp
index 996df92..a4377e2 100644
--- a/idaloader.cpp
+++ b/idaloader.cpp
@@ -280,8 +280,9 @@ void idaapi load_file(linput_t *li, ushort /*_neflags*/, const char * /*fileform
   comp.size_ldbl = 0;
   set_compiler(comp, SETCOMP_OVERRIDE);
 
-  inf_set_baseaddr(0);
-  inf_set_64bit(false); // needed for hexppc64 to treat us as 32bit
+  ea_helper_t eah;
+  eah.setup(false);   // file format does not support 64-bit data
+  inf_set_64bit(false);
 
   qlseek(li, 0);
 
@@ -290,6 +291,9 @@ void idaapi load_file(linput_t *li, ushort /*_neflags*/, const char * /*fileform
   bool result = file.load(li);
   if (result)
   {
+    inf_set_baseaddr(file.base_address() >> 4);
+    set_imagebase(file.base_address());
+
     // If this is XEX2 try loading in x360.til, in case we have one
     if (file.header().Magic == MAGIC_XEX2)
       add_til("x360.til", 0);
