From 755693429cb4a53cadf37b00e626e4410abdfafd Mon Sep 17 00:00:00 2001
From: Sambit Das <dsambit@umich.edu>
Date: Sun, 26 May 2019 17:51:05 -0400
Subject: [PATCH] Fixed band parallelization issue in residual computation.

---
 src/linAlg/linearAlgebraOperationsOpt.cc | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/linAlg/linearAlgebraOperationsOpt.cc b/src/linAlg/linearAlgebraOperationsOpt.cc
index 62d3ab071..e3457d46b 100644
--- a/src/linAlg/linearAlgebraOperationsOpt.cc
+++ b/src/linAlg/linearAlgebraOperationsOpt.cc
@@ -986,7 +986,9 @@ namespace dftfe{
       // D is the eigenvalues matrix.
       // The blocked approach avoids additional full
       // wavefunction matrix memory
-      const unsigned int vectorsBlockSize=dftParameters::wfcBlockSize;
+      const unsigned int vectorsBlockSize=std::min(dftParameters::wfcBlockSize,
+		                                   bandGroupLowHighPlusOneIndices[1]);
+
       for (unsigned int jvec = 0; jvec < totalNumberVectors; jvec += vectorsBlockSize)
       {
 	  // Correct block dimensions if block "goes off edge"
