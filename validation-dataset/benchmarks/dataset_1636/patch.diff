From 6ade83e635ccd1c017dc25755b3dd21230a9683f Mon Sep 17 00:00:00 2001
From: Anton Kudryavtsev <anton.kudryavtsev@vk.team>
Date: Wed, 23 Aug 2023 11:56:27 +0300
Subject: [PATCH] http2protocol: use QSB to reduce allocations
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change-Id: I9bc312e6c7e4b7c8f613b88e206a2a23f9e23722
Reviewed-by: MÃ¥rten Nordheim <marten.nordheim@qt.io>
---
 src/network/access/http2/http2protocol.cpp | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/src/network/access/http2/http2protocol.cpp b/src/network/access/http2/http2protocol.cpp
index 966f294e8161..2b754830fb35 100644
--- a/src/network/access/http2/http2protocol.cpp
+++ b/src/network/access/http2/http2protocol.cpp
@@ -76,12 +76,10 @@ void appendProtocolUpgradeHeaders(const QHttp2Configuration &config, QHttpNetwor
     Q_ASSERT(request);
     // RFC 2616, 14.10
     // RFC 7540, 3.2
-    QByteArray value(request->headerField("Connection"));
+    const QByteArray connectionHeader = request->headerField("Connection");
+    const auto separator = connectionHeader.isEmpty() ? QByteArrayView() : QByteArrayView(", ");
     // We _append_ 'Upgrade':
-    if (value.size())
-        value += ", ";
-
-    value += "Upgrade, HTTP2-Settings";
+    QByteArray value = connectionHeader + separator + "Upgrade, HTTP2-Settings";
     request->setHeaderField("Connection", value);
     // This we just (re)write.
     request->setHeaderField("Upgrade", "h2c");
