From 74ada30c7fd830da543676e9584d5b4d1f879c08 Mon Sep 17 00:00:00 2001
From: NotCompsky <adammarkgray@gmail.com>
Date: Sat, 1 Aug 2020 15:03:50 +0100
Subject: [PATCH] Performance		Replace WHERE NOT IN with LEFT JOIN
 ... IS NULL

---
 wangle-server/src/server.cpp | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/wangle-server/src/server.cpp b/wangle-server/src/server.cpp
index 49bfd2e3..cfaaf6b8 100644
--- a/wangle-server/src/server.cpp
+++ b/wangle-server/src/server.cpp
@@ -1682,9 +1682,11 @@ class RTaggerHandler : public wangle::HandlerAdapter<const std::string_view,  co
 			"FROM dir d "
 			"LEFT JOIN dir2tag d2t ON d2t.dir=d.id "
 			"JOIN file f ON f.dir=d.id "
+			"LEFT JOIN" USER_DISALLOWED_FILES(user_id) "A ON A.id=f.id "
+			"LEFT JOIN" USER_DISALLOWED_DIRS(user_id)  "B ON B.id=d.id "
 			"WHERE d.id IN (", ids_args..., ")"
-			  FILE_TBL_USER_PERMISSION_FILTER(user_id)
-			  DIR_TBL_USER_PERMISSION_FILTER(user_id)
+			  "AND A.id IS NULL "
+			  "AND B.id IS NULL "
 			"GROUP BY d.id "
 			"ORDER BY FIELD(d.id,", ids_args..., ")"
 			"LIMIT 100 "
