From a27dd352f1f8a7b6a540e5d732c5a9351d76808a Mon Sep 17 00:00:00 2001
From: emmerik <emmerik@gmail.com>
Date: Wed, 22 Jun 2011 12:48:01 +0000
Subject: [PATCH] Replaced "/ RPM_FWD_MAX" with "* (1.0 / RPM_FWD_MAX)" because
 gcc somehow fails to perform the obvious strength reduction (replacing a
 divide by a constant with a multiply by the inverse of the constant). The
 slight extra speed may help improve stability.

---
 master/tritium/pedal.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/master/tritium/pedal.c b/master/tritium/pedal.c
index 8b28e85f..52d89b51 100644
--- a/master/tritium/pedal.c
+++ b/master/tritium/pedal.c
@@ -104,7 +104,8 @@ void process_pedal( unsigned int analog_a, unsigned int analog_b, unsigned int a
 				*/
 				// Dave Keenan's quadratic pedal regen algorithm
 			  	// See http://forums.aeva.asn.au/forums/forum_posts.asp?TID=1859&PID=30613#30613
-				float normalised_rpm = motor_rpm / RPM_FWD_MAX;
+				// Note that gcc doesn't do the obvious strength reduction, hence the 1.0 / RPM...:
+				float normalised_rpm = motor_rpm * (1.0 / RPM_FWD_MAX);
 				float p2 = pedal*pedal;		// Pedal squared
 				command.current = (CURRENT_MAX * (p2 + (p2-1)*regen*normalised_rpm));
 				// Literal implementation of Dave's pedal formulae lead to divide by zero or overflow hazards
