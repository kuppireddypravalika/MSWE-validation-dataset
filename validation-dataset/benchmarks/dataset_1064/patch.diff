From a3ba9eb60e901cfead2dd8d4e589d7dfab48e0cb Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@mines-paris.org>
Date: Sat, 11 Feb 2012 15:55:25 +0000
Subject: [PATCH] SQLite: speed-up opening of a result layer that has an ORDER
 BY

git-svn-id: https://svn.osgeo.org/gdal/trunk@23946 f0d54148-0727-0410-94bb-9a71ac55c965
---
 .../ogrsf_frmts/sqlite/ogrsqlitedatasource.cpp  | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitedatasource.cpp b/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitedatasource.cpp
index 11704c1fd997..2e7b205c0a94 100644
--- a/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitedatasource.cpp
+++ b/gdal/ogr/ogrsf_frmts/sqlite/ogrsqlitedatasource.cpp
@@ -1224,7 +1224,22 @@ OGRLayer * OGRSQLiteDataSource::ExecuteSQL( const char *pszSQLCommand,
     int rc;
     sqlite3_stmt *hSQLStmt = NULL;
 
-    rc = sqlite3_prepare( GetDB(), pszSQLCommand, strlen(pszSQLCommand),
+    CPLString osSQLCommand = pszSQLCommand;
+
+    /* This will speed-up layer creation */
+    /* ORDER BY are costly to evaluate and are not necessary to establish */
+    /* the layer definition. */
+    if( osSQLCommand.ifind("SELECT ") == 0 &&
+        osSQLCommand.ifind(" UNION ") == std::string::npos &&
+        osSQLCommand.ifind(" INTERSECT ") == std::string::npos &&
+        osSQLCommand.ifind(" EXCEPT ") == std::string::npos )
+    {
+        size_t nOrderByPos = osSQLCommand.ifind(" ORDER BY ");
+        if( nOrderByPos != std::string::npos )
+            osSQLCommand.resize(nOrderByPos);
+    }
+
+    rc = sqlite3_prepare( GetDB(), osSQLCommand.c_str(), osSQLCommand.size(),
                           &hSQLStmt, NULL );
 
     if( rc != SQLITE_OK )
